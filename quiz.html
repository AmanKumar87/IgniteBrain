<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ignite Brain Quiz Platform</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Custom styles to complement Tailwind */
      body {
        font-family: "Inter", sans-serif;
      }
      /* Simple fade-in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .view-content {
        animation: fadeIn 0.5s ease-out forwards;
      }
      /* Custom radio button style */
      .form-radio {
        -webkit-appearance: none;
        appearance: none;
        background-color: #fff;
        margin: 0;
        font: inherit;
        color: currentColor;
        width: 1.15em;
        height: 1.15em;
        border: 0.15em solid #94a3b8;
        border-radius: 50%;
        transform: translateY(-0.075em);
        display: grid;
        place-content: center;
      }
      .form-radio::before {
        content: "";
        width: 0.65em;
        height: 0.65em;
        border-radius: 50%;
        transform: scale(0);
        transition: 120ms transform ease-in-out;
        box-shadow: inset 1em 1em #f97316; /* orange-500 */
      }
      .form-radio:checked {
        border-color: #f97316;
      }
      .form-radio:checked::before {
        transform: scale(1);
      }
      /* Custom scrollbar for modals */
      .modal-body::-webkit-scrollbar {
        width: 8px;
      }
      .modal-body::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      .modal-body::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .modal-body::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Styles for the role selection buttons */
      .role-select-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 280px;
        height: 280px;
        background-color: white;
        border-radius: 1.5rem;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        transition: all 0.2s ease-in-out;
        border: 2px solid transparent;
      }
      .role-select-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1),
          0 8px 10px -6px rgb(0 0 0 / 0.1);
        border-color: #f97316;
      }
    </style>
  </head>
  <body class="bg-stone-100 text-stone-800">
    <!-- Main Application Container -->
    <div id="app-container">
      <!-- Header (Dynamically shown) -->
      <header
        id="app-header"
        class="bg-white shadow-sm p-4 flex justify-between items-center hidden sticky top-0 z-40"
      >
        <h1 class="text-xl font-bold text-orange-500">Ignite Brain Quiz</h1>
        <div>
          <span id="user-name" class="text-stone-600 mr-4"></span>
          <button
            id="logout-btn"
            class="text-sm font-semibold text-stone-600 hover:text-orange-500"
          >
            Logout
          </button>
        </div>
      </header>

      <!-- Main Content Area where all views will be rendered -->
      <main id="main-content">
        <!-- JS will render the initial view here -->
      </main>

      <!-- Modal Container -->
      <div
        id="modal-container"
        class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
      >
        <!-- Modal content is injected here -->
      </div>
    </div>

    <!-- Main Application Script -->
    <script type="module">
      // --- Global State & Elements ---
      const appHeader = document.getElementById("app-header");
      const userNameEl = document.getElementById("user-name");
      const logoutBtn = document.getElementById("logout-btn");
      const modalContainer = document.getElementById("modal-container");
      const mainContent = document.getElementById("main-content");
      let currentUser = null;
      let quizTimerInterval = null;
      let questionTimerInterval = null;

      // --- Persistent Data Management using localStorage ---
      let database = {};

      const saveDatabase = () => {
        localStorage.setItem("quizAppDatabase", JSON.stringify(database));
      };

      const loadDatabase = () => {
        const savedDb = localStorage.getItem("quizAppDatabase");
        if (savedDb) {
          database = JSON.parse(savedDb);
          if (database.quizzes)
            database.quizzes.forEach(
              (q) => (q.createdAt = new Date(q.createdAt))
            );
          if (database.quizAttempts)
            database.quizAttempts.forEach(
              (a) => (a.timestamp = new Date(a.timestamp))
            );
        } else {
          database = {
            users: [],
            questionPools: [],
            quizzes: [],
            quizAttempts: [],
          };
        }

        if (!database.users.some((u) => u.email === "teacher@example.com")) {
          database.users.push({
            uid: "teacher1",
            name: "Sample Teacher",
            email: "teacher@example.com",
            password: "123",
            role: "teacher",
          });
        }
        if (!database.users.some((u) => u.email === "student@example.com")) {
          database.users.push({
            uid: "student1",
            name: "Sample Student",
            email: "student@example.com",
            password: "123",
            role: "student",
          });
        }
        saveDatabase();
      };

      // --- Helper Functions ---
      const shuffleArray = (array) => {
        let newArr = [...array];
        for (let i = newArr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
        }
        return newArr;
      };
      const generateId = (length = 6) => {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let result = "";
        for (let i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      };

      // --- App Logic ---
      const init = () => {
        loadDatabase();
        logoutBtn.addEventListener("click", () => {
          currentUser = null;
          appHeader.classList.add("hidden");
          renderRoleSelectionView();
        });
        renderRoleSelectionView();
      };

      // --- Modal Management ---
      const showModal = (content) => {
        modalContainer.innerHTML = content;
        modalContainer.classList.remove("hidden");
        modalContainer.classList.add("flex");
      };
      const hideModal = () => {
        modalContainer.classList.add("hidden");
        modalContainer.classList.remove("flex");
        modalContainer.innerHTML = "";
      };

      // --- Render Functions ---

      const renderRoleSelectionView = () => {
        mainContent.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center p-4 bg-stone-100 view-content">
                    <h1 class="text-4xl font-bold text-orange-500 mb-2">Ignite Brain Quiz</h1>
                    <p class="text-xl text-stone-600 mb-12">Who are you?</p>
                    <div class="flex flex-col md:flex-row gap-6">
                        <button id="select-teacher-btn" class="role-select-btn">
                            <span class="text-5xl mb-4">üë©‚Äçüè´</span>
                            <span class="text-2xl font-semibold">I am a Teacher</span>
                        </button>
                        <button id="select-student-btn" class="role-select-btn">
                            <span class="text-5xl mb-4">üéì</span>
                            <span class="text-2xl font-semibold">I am a Student</span>
                        </button>
                    </div>
                </div>
            `;
        document
          .getElementById("select-teacher-btn")
          .addEventListener("click", () => renderAuthView("teacher"));
        document
          .getElementById("select-student-btn")
          .addEventListener("click", () => renderAuthView("student"));
      };

      const renderAuthView = (selectedRole) => {
        let isLogin = true;

        const render = () => {
          mainContent.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 relative view-content">
                        <button id="back-to-role-select" class="absolute top-6 left-6 text-stone-500 hover:text-stone-800 font-semibold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            Back
                        </button>
                        <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8">
                            <h2 class="text-3xl font-bold text-center text-stone-800 mb-2">${
                              isLogin ? "Login" : "Sign Up"
                            } as a ${
            selectedRole.charAt(0).toUpperCase() + selectedRole.slice(1)
          }</h2>
                            <p class="text-center text-stone-500 mb-6">Welcome to Ignite Brain Quizzes</p>
                            <div id="auth-error" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                            <form id="auth-form">
                                ${
                                  !isLogin
                                    ? `<input type="text" id="name-input" placeholder="Full Name" class="w-full p-3 mb-4 bg-stone-50 rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-orange-400" required />`
                                    : ""
                                }
                                <input type="email" id="email-input" placeholder="Email Address" class="w-full p-3 mb-4 bg-stone-50 rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-orange-400" required />
                                <input type="password" id="password-input" placeholder="Password" class="w-full p-3 mb-4 bg-stone-50 rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-orange-400" required />
                                <button type="submit" class="w-full bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                                    ${isLogin ? "Log In" : "Create Account"}
                                </button>
                            </form>
                            <p class="text-center text-sm text-stone-500 mt-6">
                                ${
                                  isLogin
                                    ? "Don't have an account?"
                                    : "Already have an account?"
                                }
                                <button id="toggle-auth" class="font-semibold text-orange-500 hover:underline ml-1">${
                                  isLogin ? "Sign Up" : "Log In"
                                }</button>
                            </p>
                        </div>
                    </div>
                `;

          document
            .getElementById("back-to-role-select")
            .addEventListener("click", renderRoleSelectionView);
          document
            .getElementById("toggle-auth")
            .addEventListener("click", () => {
              isLogin = !isLogin;
              render();
            });
          document
            .getElementById("auth-form")
            .addEventListener("submit", handleAuth);
        };

        const handleAuth = (e) => {
          e.preventDefault();
          // THIS IS THE FIX: Reload database from storage before auth attempt
          loadDatabase();
          const errorEl = document.getElementById("auth-error");
          errorEl.classList.add("hidden");
          const email = document.getElementById("email-input").value;
          const password = document.getElementById("password-input").value;

          if (isLogin) {
            const user = database.users.find(
              (u) =>
                u.email === email &&
                u.password === password &&
                u.role === selectedRole
            );
            if (user) {
              currentUser = user;
            } else {
              errorEl.textContent = "Invalid credentials or role mismatch.";
              errorEl.classList.remove("hidden");
              return;
            }
          } else {
            const name = document.getElementById("name-input").value;
            if (database.users.some((u) => u.email === email)) {
              errorEl.textContent =
                "An account with this email already exists.";
              errorEl.classList.remove("hidden");
              return;
            }
            currentUser = {
              uid: generateId(10),
              name,
              email,
              password,
              role: selectedRole,
            };
            database.users.push(currentUser);
            saveDatabase();
          }

          userNameEl.textContent = `Welcome, ${currentUser.name}!`;
          appHeader.classList.remove("hidden");

          if (currentUser.role === "teacher") {
            renderTeacherDashboard();
          } else {
            renderStudentDashboard();
          }
        };

        render();
      };

      const renderTeacherDashboard = () => {
        const updateDashboard = () => {
          mainContent.innerHTML = `
                    <div class="p-4 md:p-8 view-content">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                            <h1 class="text-3xl font-bold">Teacher Dashboard</h1>
                            <div>
                                <button id="create-pool-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 mr-2">Create Question Pool</button>
                                <button id="create-quiz-btn" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-600">Create New Quiz</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h2 class="text-2xl font-semibold mb-4">My Quizzes</h2>
                                <div id="quiz-list" class="space-y-4"></div>
                            </div>
                            <div>
                                <h2 class="text-2xl font-semibold mb-4">My Question Pools</h2>
                                <div id="pool-list" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>
                `;

          document
            .getElementById("create-pool-btn")
            .addEventListener("click", renderCreatePoolModal);
          document
            .getElementById("create-quiz-btn")
            .addEventListener("click", renderCreateQuizModal);

          const poolListEl = document.getElementById("pool-list");
          const teacherPools = database.questionPools.filter(
            (p) => p.teacherId === currentUser.uid
          );
          poolListEl.innerHTML =
            teacherPools.length === 0
              ? `<p class="text-stone-500">You haven't created any question pools yet.</p>`
              : teacherPools
                  .map(
                    (pool) => `
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <h3 class="font-semibold">${pool.name}</h3>
                            <p class="text-sm text-stone-500">${pool.questions.length} questions</p>
                        </div>
                    `
                  )
                  .join("");

          const quizListEl = document.getElementById("quiz-list");
          const teacherQuizzes = database.quizzes.filter(
            (q) => q.teacherId === currentUser.uid
          );
          quizListEl.innerHTML =
            teacherQuizzes.length === 0
              ? `<p class="text-stone-500">You haven't created any quizzes yet.</p>`
              : teacherQuizzes
                  .map(
                    (quiz) => `
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg">${
                                      quiz.quizTitle
                                    }</h3>
                                    <p class="text-sm text-stone-500">Code: <span class="font-mono bg-stone-200 px-2 py-1 rounded">${
                                      quiz.id
                                    }</span></p>
                                    <p class="text-sm mt-1 ${
                                      quiz.published
                                        ? "text-green-600"
                                        : "text-red-600"
                                    }">${
                      quiz.published ? "Published" : "Not Published"
                    }</p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <button data-quiz-id="${
                                      quiz.id
                                    }" class="publish-btn text-xs font-semibold px-3 py-1 rounded-full ${
                      quiz.published
                        ? "bg-gray-200 text-gray-700"
                        : "bg-green-500 text-white"
                    }">
                                        ${
                                          quiz.published
                                            ? "Unpublish"
                                            : "Publish"
                                        }
                                    </button>
                                    <button data-quiz-id="${
                                      quiz.id
                                    }" class="results-btn text-xs font-semibold px-3 py-1 rounded-full bg-blue-500 text-white">View Results</button>
                                </div>
                            </div>
                        </div>
                    `
                  )
                  .join("");

          quizListEl
            .querySelectorAll(".results-btn")
            .forEach((el) =>
              el.addEventListener("click", (e) =>
                renderQuizResultsModal(e.target.dataset.quizId)
              )
            );
          quizListEl.querySelectorAll(".publish-btn").forEach((el) =>
            el.addEventListener("click", (e) => {
              const quiz = database.quizzes.find(
                (q) => q.id === e.target.dataset.quizId
              );
              if (quiz) {
                quiz.published = !quiz.published;
                saveDatabase();
                updateDashboard();
              }
            })
          );
        };
        updateDashboard();
      };

      const renderCreatePoolModal = () => {
        let questions = [
          { questionText: "", options: ["", ""], correctAnswerIndex: 0 },
        ];
        let poolName = "";

        const renderQuestions = () => {
          const questionsContainer = document.getElementById(
            "questions-container"
          );
          if (!questionsContainer) return;

          questionsContainer.innerHTML = questions
            .map(
              (q, qIndex) => `
                    <div class="bg-stone-50 p-4 rounded-lg mb-4 border">
                        <label class="font-semibold">Question ${
                          qIndex + 1
                        }</label>
                        <textarea data-q-index="${qIndex}" class="question-text w-full p-2 mt-1 mb-2 bg-white rounded-lg border" rows="2" placeholder="Enter question text">${
                q.questionText
              }</textarea>
                        <div id="options-for-q-${qIndex}">
                            ${q.options
                              .map(
                                (opt, oIndex) => `
                                <div class="flex items-center gap-2 mb-2">
                                    <input type="radio" name="correct-answer-${qIndex}" value="${oIndex}" class="form-radio" ${
                                  q.correctAnswerIndex === oIndex
                                    ? "checked"
                                    : ""
                                } />
                                    <input type="text" data-q-index="${qIndex}" data-o-index="${oIndex}" class="option-text w-full p-2 bg-white rounded-lg border" placeholder="Option ${
                                  oIndex + 1
                                }" value="${opt}" />
                                </div>
                            `
                              )
                              .join("")}
                        </div>
                        <button type="button" data-q-index="${qIndex}" class="add-option-btn text-xs font-semibold text-green-600 hover:underline">+ Add Option</button>
                    </div>
                `
            )
            .join("");

          attachQuestionListeners();
        };

        const attachQuestionListeners = () => {
          document.querySelectorAll(".add-option-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const qIndex = e.target.dataset.qIndex;
              questions[qIndex].options.push("");
              renderQuestions();
            });
          });

          document.querySelectorAll(".question-text").forEach((el) =>
            el.addEventListener("input", (e) => {
              questions[e.target.dataset.qIndex].questionText = e.target.value;
            })
          );
          document.querySelectorAll(".option-text").forEach((el) =>
            el.addEventListener("input", (e) => {
              questions[e.target.dataset.qIndex].options[
                e.target.dataset.oIndex
              ] = e.target.value;
            })
          );
          document.querySelectorAll('input[type="radio"]').forEach((el) =>
            el.addEventListener("change", (e) => {
              questions[e.target.name.split("-")[2]].correctAnswerIndex =
                parseInt(e.target.value);
            })
          );
        };

        showModal(`
                <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg transform transition-all">
                    <form id="pool-form">
                        <div class="p-6 border-b"><h2 class="text-2xl font-bold">Create New Question Pool</h2></div>
                        <div class="p-6 max-h-[60vh] overflow-y-auto modal-body">
                            <label class="font-semibold">Pool Name</label>
                            <input type="text" id="pool-name" class="w-full p-2 mt-1 mb-6 bg-stone-100 rounded-lg border" required />
                            <div id="questions-container"></div>
                            <button type="button" id="add-question-btn" class="mt-4 text-sm font-semibold text-blue-500 hover:underline">+ Add Another Question</button>
                        </div>
                        <div class="p-6 bg-stone-50 flex justify-end gap-4 rounded-b-2xl">
                            <button type="button" id="cancel-pool" class="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg font-semibold">Cancel</button>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold">Save Pool</button>
                        </div>
                    </form>
                </div>
            `);

        const poolNameInput = document.getElementById("pool-name");
        const modalBody = modalContainer.querySelector(".modal-body");

        poolNameInput.addEventListener("input", () => {
          poolName = poolNameInput.value;
        });

        document
          .getElementById("cancel-pool")
          .addEventListener("click", hideModal);
        document.getElementById("pool-form").addEventListener("submit", (e) => {
          e.preventDefault();
          if (
            !poolName ||
            questions.some((q) => !q.questionText || q.options.some((o) => !o))
          ) {
            alert("Please fill out all fields.");
            return;
          }
          database.questionPools.push({
            id: generateId(),
            name: poolName,
            teacherId: currentUser.uid,
            questions,
          });
          saveDatabase();
          hideModal();
          renderTeacherDashboard();
        });
        document
          .getElementById("add-question-btn")
          .addEventListener("click", () => {
            questions.push({
              questionText: "",
              options: ["", ""],
              correctAnswerIndex: 0,
            });
            renderQuestions();
            poolNameInput.value = poolName; // Restore pool name
            modalBody.scrollTop = modalBody.scrollHeight; // Scroll to bottom
          });

        renderQuestions();
      };

      const renderCreateQuizModal = () => {
        const pools = database.questionPools.filter(
          (p) => p.teacherId === currentUser.uid
        );
        if (pools.length === 0) {
          alert("You must create a question pool before creating a quiz.");
          return;
        }

        showModal(`
                <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg transform transition-all">
                    <form id="quiz-form">
                        <div class="p-6 border-b"><h2 class="text-2xl font-bold">Create New Quiz</h2></div>
                        <div class="p-6 space-y-4 modal-body">
                            <div><label class="font-semibold">Quiz Title</label><input type="text" id="quiz-title" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border" required /></div>
                            <div><label class="font-semibold">Select Question Pool</label><select id="quiz-pool" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border">${pools
                              .map(
                                (p) =>
                                  `<option value="${p.id}">${p.name} (${p.questions.length} questions)</option>`
                              )
                              .join("")}</select></div>
                            <div><label class="font-semibold">Number of Questions to Ask</label><input type="number" id="quiz-questions-num" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border" min="1" required /></div>
                            <div><label class="font-semibold">Overall Time Limit (minutes)</label><input type="number" id="quiz-time" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border" min="1" required /></div>
                            <div><label class="font-semibold">Time Per Question (seconds, optional)</label><input type="number" id="quiz-question-time" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border" min="60" placeholder="Min 60 seconds (1 minute)" /></div>
                        </div>
                        <div class="p-6 bg-stone-50 flex justify-end gap-4 rounded-b-2xl">
                            <button type="button" id="cancel-quiz" class="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg font-semibold">Cancel</button>
                            <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold">Create Quiz</button>
                        </div>
                    </form>
                </div>
            `);

        document
          .getElementById("cancel-quiz")
          .addEventListener("click", hideModal);
        document.getElementById("quiz-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const quizTitle = document.getElementById("quiz-title").value;
          const poolId = document.getElementById("quiz-pool").value;
          const numberOfQuestions = parseInt(
            document.getElementById("quiz-questions-num").value
          );
          const totalTime = parseInt(
            document.getElementById("quiz-time").value
          );
          const timePerQuestion = document.getElementById("quiz-question-time")
            .value
            ? parseInt(document.getElementById("quiz-question-time").value)
            : null;

          const selectedPool = pools.find((p) => p.id === poolId);
          if (numberOfQuestions > selectedPool.questions.length) {
            alert(
              `You can only ask for a maximum of ${selectedPool.questions.length} questions from this pool.`
            );
            return;
          }

          database.quizzes.push({
            id: generateId(),
            quizTitle,
            poolId,
            numberOfQuestions,
            totalTime,
            timePerQuestion,
            teacherId: currentUser.uid,
            published: false,
            createdAt: new Date(),
          });
          saveDatabase();
          hideModal();
          renderTeacherDashboard();
        });
      };

      const renderQuizResultsModal = (quizId) => {
        showModal(`
                <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg transform transition-all">
                    <div class="p-6 border-b flex justify-between items-center"><h2 class="text-2xl font-bold">Quiz Results</h2><button id="close-results" class="text-2xl">&times;</button></div>
                    <div id="results-body" class="p-6 max-h-[70vh] overflow-y-auto modal-body"></div>
                </div>
            `);
        document
          .getElementById("close-results")
          .addEventListener("click", hideModal);

        const resultsBody = document.getElementById("results-body");
        const attempts = database.quizAttempts.filter(
          (a) => a.quizId === quizId
        );
        if (attempts.length === 0) {
          resultsBody.innerHTML = `<p class="text-stone-500">No students have completed this quiz yet.</p>`;
          return;
        }
        resultsBody.innerHTML = `
                <table class="w-full text-left">
                    <thead><tr class="border-b"><th class="p-2">Student</th><th class="p-2">Score</th><th class="p-2">Date</th></tr></thead>
                    <tbody>
                        ${attempts
                          .map(
                            (attempt) => `
                            <tr class="border-b">
                                <td class="p-2">${attempt.studentName}</td>
                                <td class="p-2">${attempt.score} / ${
                              attempt.totalQuestions
                            }</td>
                                <td class="p-2 text-sm text-stone-500">${new Date(
                                  attempt.timestamp
                                ).toLocaleString()}</td>
                            </tr>
                        `
                          )
                          .join("")}
                    </tbody>
                </table>
            `;
      };

      const renderStudentDashboard = () => {
        mainContent.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 view-content">
                    <div class="w-full max-w-md text-center">
                        <h1 class="text-4xl font-bold text-stone-800">Welcome, ${currentUser.name}!</h1>
                        <p class="text-stone-600 mt-2 mb-8">Enter a quiz code from your teacher to begin.</p>
                        
                        <div class="bg-white rounded-2xl shadow-lg p-8">
                            <div id="student-error" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                            <input type="text" id="quiz-code-input" placeholder="Enter Quiz Code" class="w-full p-4 text-center text-lg bg-stone-50 rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-orange-400 uppercase" />
                            <button id="start-quiz-btn" class="w-full mt-4 bg-orange-500 text-white p-4 rounded-lg font-semibold text-lg hover:bg-orange-600 transition-colors">
                                Start Quiz
                            </button>
                        </div>
                    </div>
                </div>
             `;
        document
          .getElementById("start-quiz-btn")
          .addEventListener("click", handleStartQuiz);
      };

      const handleStartQuiz = () => {
        const errorEl = document.getElementById("student-error");
        errorEl.classList.add("hidden");
        const quizCode = document
          .getElementById("quiz-code-input")
          .value.trim()
          .toUpperCase();
        if (!quizCode) {
          errorEl.textContent = "Please enter a quiz code.";
          errorEl.classList.remove("hidden");
          return;
        }
        const quiz = database.quizzes.find((q) => q.id === quizCode);

        if (quiz && quiz.published) {
          renderQuizTaker(quiz);
        } else if (quiz && !quiz.published) {
          errorEl.textContent =
            "This quiz has not been published by your teacher yet.";
          errorEl.classList.remove("hidden");
        } else {
          errorEl.textContent =
            "Quiz not found. Please check the code and try again.";
          errorEl.classList.remove("hidden");
        }
      };

      const renderQuizTaker = (quiz) => {
        const pool = database.questionPools.find((p) => p.id === quiz.poolId);
        if (!pool) {
          mainContent.innerHTML = `<div class="p-8"><p class="text-red-500">Error: Question pool for this quiz could not be found.</p></div>`;
          return;
        }

        const questions = shuffleArray(pool.questions).slice(
          0,
          quiz.numberOfQuestions
        );
        let currentQuestionIndex = 0;
        let answers = {};
        let score = null;
        let totalTimeLeft = quiz.totalTime * 60;
        let questionTimeLeft = quiz.timePerQuestion;

        const handleSubmit = () => {
          if (score !== null) return;
          clearInterval(quizTimerInterval);
          clearInterval(questionTimerInterval);

          let calculatedScore = 0;
          questions.forEach((q, index) => {
            if (answers[index] === q.correctAnswerIndex) {
              calculatedScore++;
            }
          });
          score = calculatedScore;

          database.quizAttempts.push({
            quizId: quiz.id,
            studentId: currentUser.uid,
            studentName: currentUser.name,
            score: calculatedScore,
            totalQuestions: questions.length,
            answers,
            timestamp: new Date(),
          });
          saveDatabase();

          renderQuizResults();
        };

        const renderQuizResults = () => {
          mainContent.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 view-content">
                        <div class="w-full max-w-md text-center bg-white rounded-2xl shadow-lg p-8">
                            <h2 class="text-3xl font-bold text-stone-800 mb-4">Quiz Complete!</h2>
                            <p class="text-5xl font-bold text-orange-500 my-6">${score} / ${questions.length}</p>
                            <p class="text-stone-600 mb-8">Your results have been submitted to your teacher.</p>
                            <button id="back-to-dash-btn" class="bg-stone-200 text-stone-700 px-6 py-3 rounded-lg font-semibold hover:bg-stone-300">Back to Dashboard</button>
                        </div>
                    </div>
                `;
          document
            .getElementById("back-to-dash-btn")
            .addEventListener("click", renderStudentDashboard);
        };

        const nextQuestion = () => {
          if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            questionTimeLeft = quiz.timePerQuestion;
            renderQuestion();
          } else {
            handleSubmit();
          }
        };

        const renderQuestion = () => {
          if (score !== null) return;
          const q = questions[currentQuestionIndex];
          const totalMinutes = Math.floor(totalTimeLeft / 60);
          const totalSeconds = totalTimeLeft % 60;

          mainContent.innerHTML = `
                    <div class="min-h-screen p-4 md:p-8 view-content">
                        <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
                            <div class="p-6 border-b flex justify-between items-center">
                                <div>
                                    <h2 class="text-2xl font-bold text-stone-800">${
                                      quiz.quizTitle
                                    }</h2>
                                    <p class="text-stone-500">Question ${
                                      currentQuestionIndex + 1
                                    } of ${questions.length}</p>
                                </div>
                                <div id="total-timer" class="bg-orange-100 text-orange-600 font-bold text-lg px-4 py-2 rounded-full">
                                    ${totalMinutes}:${
            totalSeconds < 10 ? `0${totalSeconds}` : totalSeconds
          }
                                </div>
                            </div>
                            <div class="p-6">
                                ${
                                  quiz.timePerQuestion
                                    ? `<div class="text-center mb-4"><p class="text-sm text-stone-500">Time for this question: <span id="question-timer" class="font-bold">${questionTimeLeft}s</span></p></div>`
                                    : ""
                                }
                                <p class="text-xl text-stone-700 mb-6">${
                                  q.questionText
                                }</p>
                                <div id="options-container" class="space-y-3">
                                    ${q.options
                                      .map(
                                        (option, index) => `
                                        <button data-option-index="${index}" class="option-btn w-full text-left p-4 rounded-lg border-2 transition-all bg-white border-stone-200 hover:border-orange-400 hover:bg-orange-50">
                                            ${option}
                                        </button>
                                    `
                                      )
                                      .join("")}
                                </div>
                            </div>
                            <div class="p-6 bg-stone-50 flex justify-end">
                                <button id="next-btn" class="bg-orange-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-600">${
                                  currentQuestionIndex < questions.length - 1
                                    ? "Next Question"
                                    : "Submit Quiz"
                                }</button>
                            </div>
                        </div>
                    </div>
                `;

          const optionsContainer = document.getElementById("options-container");
          optionsContainer.addEventListener("click", (e) => {
            if (e.target.classList.contains("option-btn")) {
              answers[currentQuestionIndex] = parseInt(
                e.target.dataset.optionIndex
              );
              optionsContainer
                .querySelectorAll(".option-btn")
                .forEach((btn) => {
                  btn.classList.remove(
                    "bg-orange-500",
                    "border-orange-500",
                    "text-white"
                  );
                });
              e.target.classList.add(
                "bg-orange-500",
                "border-orange-500",
                "text-white"
              );
            }
          });

          document
            .getElementById("next-btn")
            .addEventListener("click", nextQuestion);
        };

        quizTimerInterval = setInterval(() => {
          totalTimeLeft--;
          if (totalTimeLeft <= 0) handleSubmit();
          const timerEl = document.getElementById("total-timer");
          if (timerEl) {
            const minutes = Math.floor(totalTimeLeft / 60);
            const seconds = totalTimeLeft % 60;
            timerEl.textContent = `${minutes}:${
              seconds < 10 ? `0${seconds}` : seconds
            }`;
          }
        }, 1000);

        if (quiz.timePerQuestion) {
          questionTimerInterval = setInterval(() => {
            questionTimeLeft--;
            if (questionTimeLeft <= 0) nextQuestion();
            const qTimerEl = document.getElementById("question-timer");
            if (qTimerEl) qTimerEl.textContent = `${questionTimeLeft}s`;
          }, 1000);
        }

        renderQuestion();
      };

      // --- Start the App ---
      init();
    </script>
  </body>
</html>
