<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ignite Brain Quiz Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* Custom styles to complement Tailwind */
      body {
        font-family: "Inter", sans-serif;
      }
      /* Simple fade-in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .view-content {
        animation: fadeIn 0.5s ease-out forwards;
      }
      /* Custom radio button style */
      .form-radio {
        -webkit-appearance: none;
        appearance: none;
        background-color: #fff;
        margin: 0;
        font: inherit;
        color: currentColor;
        width: 1.15em;
        height: 1.15em;
        border: 0.15em solid #94a3b8;
        border-radius: 50%;
        transform: translateY(-0.075em);
        display: grid;
        place-content: center;
      }
      .form-radio::before {
        content: "";
        width: 0.65em;
        height: 0.65em;
        border-radius: 50%;
        transform: scale(0);
        transition: 120ms transform ease-in-out;
        box-shadow: inset 1em 1em #f97316; /* orange-500 */
      }
      .form-radio:checked {
        border-color: #f97316;
      }
      .form-radio:checked::before {
        transform: scale(1);
      }
      /* Custom scrollbar for modals and dashboard history */
      .modal-body::-webkit-scrollbar,
      .history-list::-webkit-scrollbar {
        width: 8px;
      }
      .modal-body::-webkit-scrollbar-track,
      .history-list::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      .modal-body::-webkit-scrollbar-thumb,
      .history-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .modal-body::-webkit-scrollbar-thumb:hover,
      .history-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      /* Styles for the role selection buttons */
      .role-select-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 280px;
        height: 280px;
        background-color: white;
        border-radius: 1.5rem;
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        transition: all 0.2s ease-in-out;
        border: 2px solid transparent;
      }
      .role-select-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1),
          0 8px 10px -6px rgb(0 0 0 / 0.1);
        border-color: #f97316;
      }

      /* --- NAVBAR STYLES --- */
      .link-underline {
        position: relative;
        text-decoration: none;
      }
      .link-underline::after {
        content: "";
        position: absolute;
        width: 100%;
        transform: scaleX(0);
        height: 2px;
        bottom: -4px;
        left: 0;
        background-color: #f97316;
        transform-origin: bottom right;
        transition: transform 0.25s ease-out;
      }
      .link-underline:hover::after {
        transform: scaleX(1);
        transform-origin: bottom left;
      }
      .dropdown-menu {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
        visibility: hidden;
        transition: opacity 0.2s ease-out, transform 0.2s ease-out,
          visibility 0.2s;
        transform-origin: top left;
      }
      .group:hover .dropdown-menu {
        opacity: 1;
        transform: translateY(0) scale(1);
        visibility: visible;
      }
      .dropdown-item {
        display: block;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #44403c;
        transition: background-color 0.2s ease, color 0.2s ease;
        text-decoration: none;
      }
      .dropdown-item:hover {
        background-color: #f97316;
        color: #ffffff;
      }
      .mobile-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
      }
      /* Spinner Animation */
      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }
      .spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        vertical-align: text-bottom;
        border: 0.15em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner 0.75s linear infinite;
      }
    </style>
  </head>
  <body class="bg-stone-100 text-stone-800">
    <div id="app-container">
      <header class="fixed inset-x-0 top-4 z-50">
        <nav class="relative mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
          <div
            class="flex items-center justify-between px-6 py-3 bg-white/60 backdrop-blur-xl rounded-2xl shadow-lg ring-1 ring-black/5"
          >
            <div class="flex-shrink-0">
              <a href="#" class="flex items-center">
                <div>
                  <span
                    class="text-xl font-bold text-stone-900 tracking-tighter"
                    >IGNITE BRAIN</span
                  >
                  <span class="block text-xs font-medium text-stone-500 -mt-1"
                    >by CSE PATHSHALA</span
                  >
                </div>
              </a>
            </div>
            <div class="hidden md:flex items-center gap-8">
              <a
                href="index.html"
                class="link-underline text-sm font-semibold text-stone-700"
                >Home</a
              >
              <div class="relative group py-2 -my-2">
                <a
                  href="#"
                  class="link-underline text-sm font-semibold text-stone-700 flex items-center gap-1"
                  >About
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 transition-transform duration-300 group-hover:rotate-180"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                      clip-rule="evenodd"
                    /></svg
                ></a>
                <div
                  class="dropdown-menu absolute top-full left-0 mt-2 w-56 bg-white/95 backdrop-blur-xl rounded-xl shadow-lg ring-1 ring-black/5 p-2"
                >
                  <a href="why-ignite.html" class="dropdown-item"
                    >Why Ignite Brain?</a
                  >
                  <a href="mission-vision.html" class="dropdown-item"
                    >Our Mission & Vision</a
                  >
                  <a href="whats-new.html" class="dropdown-item">What's New</a>
                  <a href="#" class="dropdown-item">Activities</a>
                  <a href="contact.html" class="dropdown-item">Contact Us</a>
                </div>
              </div>
              <div class="relative group py-2 -my-2">
                <a
                  href="#"
                  class="link-underline text-sm font-semibold text-stone-700 flex items-center gap-1"
                  >Olympiads
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-4 w-4 transition-transform duration-300 group-hover:rotate-180"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                      clip-rule="evenodd"
                    /></svg
                ></a>
                <div
                  class="dropdown-menu absolute top-full left-0 mt-2 w-56 bg-white/95 backdrop-blur-xl rounded-xl shadow-lg ring-1 ring-black/5 p-2"
                >
                  <a href="olympiads.html" class="dropdown-item"
                    >All Olympiads</a
                  >
                  <a href="techoly.html" class="dropdown-item">Tech Olympiad</a>
                  <a href="vedmatholy.html" class="dropdown-item"
                    >Vedic Maths Olympiad</a
                  >
                  <a href="paintoly.html" class="dropdown-item"
                    >Painting Olympiad</a
                  >
                  <a href="cyberoly.html" class="dropdown-item"
                    >Cyber Olympiad</a
                  >
                </div>
              </div>
              <a
                href="ai.html"
                class="link-underline text-sm font-semibold text-stone-700"
                >AI</a
              >
              <a
                href="coding.html"
                class="link-underline text-sm font-semibold text-stone-700"
                >Coding</a
              >
              <a
                href="blogs.html"
                class="link-underline text-sm font-semibold text-stone-700"
                >Blogs</a
              >
              <a
                href="lab.html"
                class="link-underline text-sm font-semibold text-stone-700"
                >Lab</a
              >
              <a
                href="#"
                class="link-underline text-sm font-semibold text-stone-700"
                >Quiz</a
              >
            </div>
            <div
              id="nav-auth-section"
              class="hidden md:flex items-center"
            ></div>
            <div class="md:hidden">
              <button
                id="mobile-menu-button"
                class="inline-flex items-center justify-center p-2 text-stone-700 rounded-md hover:bg-stone-100 hover:text-stone-900"
              >
                <span class="sr-only">Open main menu</span>
                <svg
                  class="h-6 w-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16m-7 6h7"
                  ></path>
                </svg>
              </button>
            </div>
          </div>
          <div id="mobile-menu" class="hidden md:hidden mt-2">
            <div
              class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white/95 backdrop-blur-lg rounded-xl shadow-lg ring-1 ring-black/5"
            >
              <a
                href="index.html"
                class="block px-3 py-2 rounded-md text-base font-medium text-stone-700 hover:text-white hover:bg-orange-500"
                >Home</a
              >
              <div>
                <button
                  data-accordion-button
                  class="w-full flex justify-between items-center px-3 py-2 rounded-md text-base font-medium text-stone-700 hover:text-white hover:bg-orange-500"
                >
                  <span>About</span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 transition-transform duration-300"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
                <div class="mobile-submenu">
                  <div class="pl-6 pr-2 pt-1 pb-2 space-y-1">
                    <a
                      href="why-ignite.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >Why Ignite Brain?</a
                    >
                    <a
                      href="mission-vision.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >Our Mission & Vision</a
                    >
                    <a
                      href="whats-new.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >What's New</a
                    >
                    <a
                      href="#"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >Activities</a
                    >
                    <a
                      href="contact.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >Contact Us</a
                    >
                  </div>
                </div>
              </div>
              <div>
                <button
                  data-accordion-button
                  class="w-full flex justify-between items-center px-3 py-2 rounded-md text-base font-medium text-stone-700 hover:text-white hover:bg-orange-500"
                >
                  <span>Olympiads</span>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 transition-transform duration-300"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </button>
                <div class="mobile-submenu">
                  <div class="pl-6 pr-2 pt-1 pb-2 space-y-1">
                    <a
                      href="olympiads.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >All Olympiads</a
                    >
                    <a
                      href="techoly.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >Tech Olympiad</a
                    >
                    <a
                      href="vedmatholy.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >Vedic Maths Olympiad</a
                    >
                    <a
                      href="paintoly.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >Painting Olympiad</a
                    >
                    <a
                      href="cyberoly.html"
                      class="block px-3 py-2 rounded-md text-sm font-medium text-stone-600 hover:text-white hover:bg-orange-500"
                      >Cyber Olympiad</a
                    >
                  </div>
                </div>
              </div>
              <a
                href="ai.html"
                class="block px-3 py-2 rounded-md text-base font-medium text-stone-700 hover:text-white hover:bg-orange-500"
                >AI</a
              >
              <a
                href="coding.html"
                class="block px-3 py-2 rounded-md text-base font-medium text-stone-700 hover:text-white hover:bg-orange-500"
                >Coding</a
              >
              <a
                href="blogs.html"
                class="block px-3 py-2 rounded-md text-base font-medium text-stone-700 hover:text-white hover:bg-orange-500"
                >Blogs</a
              >
              <a
                href="lab.html"
                class="block px-3 py-2 rounded-md text-base font-medium text-stone-700 hover:text-white hover:bg-orange-500"
                >Lab</a
              >
              <a
                href="#"
                class="block px-3 py-2 rounded-md text-base font-medium text-stone-700 hover:text-white hover:bg-orange-500"
                >Quiz</a
              >
              <hr class="border-stone-200 my-2" />
              <div id="mobile-auth-section"></div>
            </div>
          </div>
        </nav>
      </header>

      <main id="main-content" class="pt-32"></main>

      <div
        id="modal-container"
        class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
      ></div>
    </div>

    <script type="module">
      // --- Global State & Elements ---
      const mainContent = document.getElementById("main-content");
      const modalContainer = document.getElementById("modal-container");
      let currentUser = null;
      let quizTimerInterval = null;
      let questionTimerInterval = null;
      let activeChart = null;
      let analyticsCharts = [];

      // --- API Key Placeholder ---
      // IMPORTANT: Get your key from OpenRouter.ai and paste it here.
      const OPENROUTER_API_KEY = "YOUR_OPENROUTER_KEY";

      // --- Motivational Quotes for Gamification ---
      const motivationalQuotes = {
        first_attempt_inspiring: [
          "Every master was once a beginner. This is your first step on a great journey!",
          "The secret to getting ahead is getting started. Well done!",
          "A journey of a thousand miles begins with a single step. You've taken it.",
        ],
        dominance: [
          "You're not just on the leaderboard, you ARE the leaderboard. Incredible dominance!",
          "Another top score? This is your era of excellence. Keep it up!",
          "Consistency is the hallmark of a champion. You've proven it again.",
        ],
        shine_again: [
          "Even the best have off days. Champions are defined by how they rise after a fall. You'll be back!",
          "This one test doesn't define you. Your history of success does. Time to shine again!",
          "A minor setback for a major comeback. We believe in you!",
        ],
        improvement: [
          "Look at that progress! You're getting stronger with every quiz.",
          "Up and up! Your hard work is clearly paying off. Great improvement!",
          "You beat your own record! That's the best kind of victory.",
        ],
        solid_effort: [
          "Great job! Strong performance. Keep building on this success.",
          "Excellent work! You've got a great grasp on the material.",
          "A solid score. Your dedication is showing.",
        ],
        keep_trying: [
          "Don't be discouraged. Every mistake is a chance to learn. Review and try again!",
          "The expert in anything was once a beginner. Keep practicing!",
          "Mistakes are proof that you are trying. Let's go again!",
        ],
      };

      // --- Persistent Data Management using localStorage ---
      let database = {};

      const saveDatabase = () => {
        localStorage.setItem("quizAppDatabase", JSON.stringify(database));
      };

      const loadDatabase = () => {
        const savedDb = localStorage.getItem("quizAppDatabase");
        if (savedDb) {
          database = JSON.parse(savedDb);
          if (database.quizzes)
            database.quizzes.forEach(
              (q) => (q.createdAt = new Date(q.createdAt))
            );
          if (database.quizAttempts)
            database.quizAttempts.forEach(
              (a) => (a.timestamp = new Date(a.timestamp))
            );
        } else {
          database = {
            users: [],
            questionPools: [],
            quizzes: [],
            quizAttempts: [],
          };
        }

        if (!database.users.some((u) => u.email === "teacher@example.com")) {
          database.users.push({
            uid: "teacher1",
            name: "Sample Teacher",
            email: "teacher@example.com",
            password: "123",
            role: "teacher",
          });
        }
        if (!database.users.some((u) => u.email === "student@example.com")) {
          database.users.push({
            uid: "student1",
            name: "Sample Student",
            email: "student@example.com",
            password: "123",
            role: "student",
          });
        }
        saveDatabase();
      };

      // --- Helper Functions ---
      const shuffleArray = (array) => {
        let newArr = [...array];
        for (let i = newArr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
        }
        return newArr;
      };
      const generateId = (length = 6) => {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let result = "";
        for (let i = 0; i < length; i++) {
          result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
      };

      const getRandomQuote = (quotesArray) => {
        return quotesArray[Math.floor(Math.random() * quotesArray.length)];
      };

      const getMotivationalQuote = (
        studentId,
        currentScore,
        totalQuestions
      ) => {
        const currentPercentage = (currentScore / totalQuestions) * 100;
        const history = database.quizAttempts.filter(
          (a) => a.studentId === studentId
        );

        if (history.length <= 1) {
          return getRandomQuote(motivationalQuotes.first_attempt_inspiring);
        }

        const pastAttempts = history.slice(0, -1);
        const totalPastScore = pastAttempts.reduce(
          (sum, a) => sum + a.score,
          0
        );
        const totalPastQuestions = pastAttempts.reduce(
          (sum, a) => sum + a.totalQuestions,
          0
        );
        const averagePercentage =
          totalPastQuestions > 0
            ? (totalPastScore / totalPastQuestions) * 100
            : 0;

        if (averagePercentage >= 80 && currentPercentage >= 80) {
          return getRandomQuote(motivationalQuotes.dominance);
        }

        if (
          averagePercentage >= 70 &&
          currentPercentage < averagePercentage - 20
        ) {
          return getRandomQuote(motivationalQuotes.shine_again);
        }

        if (
          currentPercentage > averagePercentage + 10 &&
          currentPercentage > 60
        ) {
          return getRandomQuote(motivationalQuotes.improvement);
        }

        if (currentPercentage >= 75) {
          return getRandomQuote(motivationalQuotes.solid_effort);
        }

        return getRandomQuote(motivationalQuotes.keep_trying);
      };

      // --- App Logic ---
      const init = () => {
        loadDatabase();
        initNavbar();

        const savedUser = sessionStorage.getItem("currentUser");
        if (savedUser) {
          currentUser = JSON.parse(savedUser);
          updateNavUI();
          if (currentUser.role === "teacher") {
            renderTeacherDashboard();
          } else {
            renderStudentDashboard();
          }
        } else {
          updateNavUI();
          renderRoleSelectionView();
        }
      };

      window.addEventListener("storage", (event) => {
        if (event.key === "currentUser" && event.newValue === null) {
          console.log("User logged out in another tab. Reloading page.");
          window.location.reload();
          return;
        }

        if (event.key === "quizAppDatabase") {
          console.log("Database changed in another tab. Syncing data.");
          loadDatabase();

          const isOnStudentDashboard = document.getElementById(
            "student-progress-chart"
          );
          if (
            currentUser &&
            currentUser.role === "student" &&
            isOnStudentDashboard
          ) {
            renderStudentDashboard();
          }

          const isOnTeacherDashboard = document.getElementById("quiz-list");
          if (
            currentUser &&
            currentUser.role === "teacher" &&
            isOnTeacherDashboard
          ) {
            renderTeacherDashboard();
          }
        }
      });

      // --- Modal Management ---
      const showModal = (content) => {
        modalContainer.innerHTML = content;
        modalContainer.classList.remove("hidden");
        modalContainer.classList.add("flex");
      };
      const hideModal = () => {
        modalContainer.classList.add("hidden");
        modalContainer.classList.remove("flex");
        modalContainer.innerHTML = "";

        if (activeChart) activeChart.destroy();
        analyticsCharts.forEach((chart) => chart.destroy());
        activeChart = null;
        analyticsCharts = [];
      };

      const renderConfirmationModal = (message, onConfirm) => {
        showModal(`
                <div class="w-full max-w-sm bg-white rounded-2xl shadow-lg p-6 text-center">
                    <h3 class="text-lg font-semibold text-stone-800 mb-4">${message}</h3>
                    <div class="flex justify-center gap-4">
                        <button id="confirm-cancel" class="px-6 py-2 rounded-lg bg-stone-200 hover:bg-stone-300 font-semibold text-stone-700">Cancel</button>
                        <button id="confirm-delete" class="px-6 py-2 rounded-lg bg-red-500 hover:bg-red-600 font-semibold text-white">Delete</button>
                    </div>
                </div>
            `);
        document
          .getElementById("confirm-cancel")
          .addEventListener("click", hideModal);
        document
          .getElementById("confirm-delete")
          .addEventListener("click", () => {
            onConfirm();
            hideModal();
          });
      };

      // --- UI Update and Render Functions ---
      const updateNavUI = () => {
        const navAuthSection = document.getElementById("nav-auth-section");
        const mobileAuthSection = document.getElementById(
          "mobile-auth-section"
        );

        if (currentUser) {
          const userInfoHTML = `
                        <div class="flex items-center gap-4">
                            <span class="text-sm font-semibold text-stone-700">Welcome, ${currentUser.name}!</span>
                            <button class="nav-logout-btn text-sm font-semibold text-red-500 hover:text-red-700">Logout</button>
                        </div>`;
          const mobileUserInfoHTML = `
                        <div class="px-3 py-2">
                            <span class="block text-base font-medium text-stone-700">Welcome, ${currentUser.name}!</span>
                            <button class="nav-logout-btn mt-2 w-full text-left block px-3 py-2 rounded-md text-base font-medium text-red-500 hover:bg-red-50">Logout</button>
                        </div>`;

          navAuthSection.innerHTML = userInfoHTML;
          mobileAuthSection.innerHTML = mobileUserInfoHTML;
        } else {
          const loginButtonHTML = `<a href="#" class="nav-login-btn group inline-flex items-center justify-center rounded-lg bg-orange-500 text-white px-5 py-2.5 text-sm font-semibold hover:bg-orange-600 transition-colors shadow-lg shadow-orange-500/20">Login / Sign Up</a>`;
          const mobileLoginButtonHTML = `<a href="#" class="nav-login-btn block px-3 py-2 rounded-md text-base font-medium text-white bg-orange-500">Login / Sign Up</a>`;

          navAuthSection.innerHTML = loginButtonHTML;
          mobileAuthSection.innerHTML = mobileLoginButtonHTML;
        }

        document
          .querySelectorAll(".nav-logout-btn")
          .forEach((btn) => btn.addEventListener("click", handleLogout));
        document
          .querySelectorAll(".nav-login-btn")
          .forEach((btn) =>
            btn.addEventListener("click", renderRoleSelectionView)
          );
      };

      const handleLogout = () => {
        sessionStorage.removeItem("currentUser");
        currentUser = null;
        loadDatabase();
        updateNavUI();
        renderRoleSelectionView();
      };

      const initNavbar = () => {
        const mobileMenuButton = document.getElementById("mobile-menu-button");
        const mobileMenu = document.getElementById("mobile-menu");
        if (mobileMenuButton) {
          mobileMenuButton.addEventListener("click", () => {
            mobileMenu.classList.toggle("hidden");
          });
        }

        const accordionButtons = document.querySelectorAll(
          "[data-accordion-button]"
        );
        accordionButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const submenu = button.nextElementSibling;
            const icon = button.querySelector("svg");
            const isExpanded =
              submenu.style.maxHeight && submenu.style.maxHeight !== "0px";

            accordionButtons.forEach((otherButton) => {
              if (otherButton !== button) {
                const otherSubmenu = otherButton.nextElementSibling;
                const otherIcon = otherButton.querySelector("svg");
                otherSubmenu.style.maxHeight = null;
                if (otherIcon) otherIcon.style.transform = "rotate(0deg)";
              }
            });

            if (isExpanded) {
              submenu.style.maxHeight = null;
              if (icon) icon.style.transform = "rotate(0deg)";
            } else {
              submenu.style.maxHeight = submenu.scrollHeight + "px";
              if (icon) icon.style.transform = "rotate(90deg)";
            }
          });
        });
      };

      const renderRoleSelectionView = () => {
        mainContent.innerHTML = `
                <div class="min-h-[calc(100vh-8rem)] flex flex-col items-center justify-center p-4 bg-stone-100 view-content">
                    <h1 class="text-4xl font-bold text-orange-500 mb-2">Ignite Brain Quiz</h1>
                    <p class="text-xl text-stone-600 mb-12">Who are you?</p>
                    <div class="flex flex-col md:flex-row gap-6">
                        <button id="select-teacher-btn" class="role-select-btn">
                            <span class="text-5xl mb-4">👩‍🏫</span>
                            <span class="text-2xl font-semibold">I am a Teacher</span>
                        </button>
                        <button id="select-student-btn" class="role-select-btn">
                            <span class="text-5xl mb-4">🎓</span>
                            <span class="text-2xl font-semibold">I am a Student</span>
                        </button>
                    </div>
                </div>
            `;
        document
          .getElementById("select-teacher-btn")
          .addEventListener("click", () => renderAuthView("teacher"));
        document
          .getElementById("select-student-btn")
          .addEventListener("click", () => renderAuthView("student"));
      };

      const renderAuthView = (selectedRole) => {
        let isLogin = true;

        const render = () => {
          mainContent.innerHTML = `
                        <div class="min-h-[calc(100vh-8rem)] flex items-center justify-center p-4 relative view-content">
                            <button id="back-to-role-select" class="absolute top-6 left-6 text-stone-500 hover:text-stone-800 font-semibold flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                                Back
                            </button>
                            <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8">
                                <h2 class="text-3xl font-bold text-center text-stone-800 mb-2">${
                                  isLogin ? "Login" : "Sign Up"
                                } as a ${
            selectedRole.charAt(0).toUpperCase() + selectedRole.slice(1)
          }</h2>
                                <p class="text-center text-stone-500 mb-6">Welcome to Ignite Brain Quizzes</p>
                                <div id="auth-error" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                                <form id="auth-form">
                                    ${
                                      !isLogin
                                        ? `<input type="text" id="name-input" placeholder="Full Name" class="w-full p-3 mb-4 bg-stone-50 rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-orange-400" required />`
                                        : ""
                                    }
                                    <input type="email" id="email-input" placeholder="Email Address" class="w-full p-3 mb-4 bg-stone-50 rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-orange-400" required />
                                    <input type="password" id="password-input" placeholder="Password" class="w-full p-3 mb-4 bg-stone-50 rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-orange-400" required />
                                    <button type="submit" class="w-full bg-orange-500 text-white p-3 rounded-lg font-semibold hover:bg-orange-600 transition-colors">
                                        ${isLogin ? "Log In" : "Create Account"}
                                    </button>
                                </form>
                                <p class="text-center text-sm text-stone-500 mt-6">
                                    ${
                                      isLogin
                                        ? "Don't have an account?"
                                        : "Already have an account?"
                                    }
                                    <button id="toggle-auth" class="font-semibold text-orange-500 hover:underline ml-1">${
                                      isLogin ? "Sign Up" : "Log In"
                                    }</button>
                                </p>
                            </div>
                        </div>
                    `;

          document
            .getElementById("back-to-role-select")
            .addEventListener("click", renderRoleSelectionView);
          document
            .getElementById("toggle-auth")
            .addEventListener("click", () => {
              isLogin = !isLogin;
              render();
            });
          document
            .getElementById("auth-form")
            .addEventListener("submit", handleAuth);
        };

        const handleAuth = (e) => {
          e.preventDefault();
          loadDatabase();
          const errorEl = document.getElementById("auth-error");
          errorEl.classList.add("hidden");
          const email = document.getElementById("email-input").value;
          const password = document.getElementById("password-input").value;

          if (isLogin) {
            const user = database.users.find(
              (u) =>
                u.email === email &&
                u.password === password &&
                u.role === selectedRole
            );
            if (user) {
              currentUser = user;
            } else {
              errorEl.textContent = "Invalid credentials or role mismatch.";
              errorEl.classList.remove("hidden");
              return;
            }
          } else {
            const name = document.getElementById("name-input").value;
            if (database.users.some((u) => u.email === email)) {
              errorEl.textContent =
                "An account with this email already exists.";
              errorEl.classList.remove("hidden");
              return;
            }
            currentUser = {
              uid: generateId(10),
              name,
              email,
              password,
              role: selectedRole,
            };
            database.users.push(currentUser);
            saveDatabase();
          }

          sessionStorage.setItem("currentUser", JSON.stringify(currentUser));
          updateNavUI();

          if (currentUser.role === "teacher") {
            renderTeacherDashboard();
          } else {
            renderStudentDashboard();
          }
        };

        render();
      };

      const renderTeacherDashboard = () => {
        const updateDashboard = () => {
          mainContent.innerHTML = `
                        <div class="p-4 md:p-8 view-content">
                            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                                <h1 class="text-3xl font-bold">Teacher Dashboard</h1>
                                <div class="flex flex-wrap gap-2">
                                    <button id="manage-students-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600">Manage Students</button>
                                    <button id="create-pool-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600">Create Question Pool</button>
                                    <button id="create-quiz-btn" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-600">Create New Quiz</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <div>
                                    <h2 class="text-2xl font-semibold mb-4">My Quizzes</h2>
                                    <div id="quiz-list" class="space-y-4"></div>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-semibold mb-4">My Question Pools</h2>
                                    <div id="pool-list" class="space-y-4"></div>
                                </div>
                            </div>
                        </div>
                    `;

          document
            .getElementById("manage-students-btn")
            .addEventListener("click", renderManageStudentsModal);
          document
            .getElementById("create-pool-btn")
            .addEventListener("click", renderCreatePoolModal);
          document
            .getElementById("create-quiz-btn")
            .addEventListener("click", renderCreateQuizModal);

          const poolListEl = document.getElementById("pool-list");
          const teacherPools = database.questionPools.filter(
            (p) => p.teacherId === currentUser.uid
          );
          poolListEl.innerHTML =
            teacherPools.length === 0
              ? `<p class="text-stone-500">You haven't created any question pools yet.</p>`
              : teacherPools
                  .map(
                    (pool) => `
                        <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${pool.name}</h3>
                                <p class="text-sm text-stone-500">${pool.questions.length} questions</p>
                            </div>
                            <button data-pool-id="${pool.id}" class="delete-pool-btn text-red-500 hover:text-red-700 p-2 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        `
                  )
                  .join("");

          const quizListEl = document.getElementById("quiz-list");
          const teacherQuizzes = database.quizzes.filter(
            (q) => q.teacherId === currentUser.uid
          );
          quizListEl.innerHTML =
            teacherQuizzes.length === 0
              ? `<p class="text-stone-500">You haven't created any quizzes yet.</p>`
              : teacherQuizzes
                  .map(
                    (quiz) => `
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg">${
                                      quiz.quizTitle
                                    }</h3>
                                    <p class="text-sm text-stone-500">Code: <span class="font-mono bg-stone-200 px-2 py-1 rounded">${
                                      quiz.id
                                    }</span></p>
                                    <p class="text-sm mt-1 ${
                                      quiz.published
                                        ? "text-green-600"
                                        : "text-red-600"
                                    }">${
                      quiz.published ? "Published" : "Not Published"
                    }</p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <button data-quiz-id="${
                                      quiz.id
                                    }" class="publish-btn text-xs font-semibold px-3 py-1 rounded-full ${
                      quiz.published
                        ? "bg-gray-200 text-gray-700"
                        : "bg-green-500 text-white"
                    }">
                                        ${
                                          quiz.published
                                            ? "Unpublish"
                                            : "Publish"
                                        }
                                    </button>
                                    <button data-quiz-id="${
                                      quiz.id
                                    }" class="results-btn text-xs font-semibold px-3 py-1 rounded-full bg-blue-500 text-white">View Analytics</button>
                                    <button data-quiz-id="${
                                      quiz.id
                                    }" class="delete-quiz-btn text-xs font-semibold px-3 py-1 rounded-full bg-red-500 text-white">Delete</button>
                                </div>
                            </div>
                        </div>
                        `
                  )
                  .join("");

          quizListEl
            .querySelectorAll(".results-btn")
            .forEach((el) =>
              el.addEventListener("click", (e) =>
                renderQuizResultsModal(e.target.dataset.quizId)
              )
            );
          quizListEl.querySelectorAll(".publish-btn").forEach((el) =>
            el.addEventListener("click", (e) => {
              const quiz = database.quizzes.find(
                (q) => q.id === e.target.dataset.quizId
              );
              if (quiz) {
                quiz.published = !quiz.published;
                saveDatabase();
                updateDashboard();
              }
            })
          );
          quizListEl.querySelectorAll(".delete-quiz-btn").forEach((el) =>
            el.addEventListener("click", (e) => {
              const quizId = e.target.dataset.quizId;
              renderConfirmationModal(
                "Are you sure you want to delete this quiz?",
                () => {
                  database.quizzes = database.quizzes.filter(
                    (q) => q.id !== quizId
                  );
                  saveDatabase();
                  updateDashboard();
                }
              );
            })
          );
          poolListEl.querySelectorAll(".delete-pool-btn").forEach((el) =>
            el.addEventListener("click", (e) => {
              const poolId = e.currentTarget.dataset.poolId;
              renderConfirmationModal(
                "This will also delete all quizzes using this pool. Are you sure?",
                () => {
                  database.questionPools = database.questionPools.filter(
                    (p) => p.id !== poolId
                  );
                  database.quizzes = database.quizzes.filter(
                    (q) => q.poolId !== poolId
                  );
                  saveDatabase();
                  updateDashboard();
                }
              );
            })
          );
        };
        updateDashboard();
      };

      const renderCreatePoolModal = () => {
        let questions = [
          { questionText: "", options: ["", ""], correctAnswerIndex: 0 },
        ];
        let poolName = "";

        const renderQuestions = () => {
          const questionsContainer = document.getElementById(
            "questions-container"
          );
          if (!questionsContainer) return;

          questionsContainer.innerHTML = questions
            .map(
              (q, qIndex) => `
                        <div class="bg-stone-50 p-4 rounded-lg mb-4 border">
                            <label class="font-semibold">Question ${
                              qIndex + 1
                            }</label>
                            <textarea data-q-index="${qIndex}" class="question-text w-full p-2 mt-1 mb-2 bg-white rounded-lg border" rows="2" placeholder="Enter question text">${
                q.questionText
              }</textarea>
                            <div id="options-for-q-${qIndex}">
                                ${q.options
                                  .map(
                                    (opt, oIndex) => `
                                <div class="flex items-center gap-2 mb-2">
                                    <input type="radio" name="correct-answer-${qIndex}" value="${oIndex}" class="form-radio" ${
                                      q.correctAnswerIndex === oIndex
                                        ? "checked"
                                        : ""
                                    } />
                                    <input type="text" data-q-index="${qIndex}" data-o-index="${oIndex}" class="option-text w-full p-2 bg-white rounded-lg border" placeholder="Option ${
                                      oIndex + 1
                                    }" value="${opt}" />
                                </div>
                                `
                                  )
                                  .join("")}
                            </div>
                            <button type="button" data-q-index="${qIndex}" class="add-option-btn text-xs font-semibold text-green-600 hover:underline">+ Add Option</button>
                        </div>
                        `
            )
            .join("");

          attachQuestionListeners();
        };

        const attachQuestionListeners = () => {
          document.querySelectorAll(".add-option-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              const qIndex = e.target.dataset.qIndex;
              questions[qIndex].options.push("");
              renderQuestions();
            });
          });

          document.querySelectorAll(".question-text").forEach((el) =>
            el.addEventListener("input", (e) => {
              questions[e.target.dataset.qIndex].questionText = e.target.value;
            })
          );
          document.querySelectorAll(".option-text").forEach((el) =>
            el.addEventListener("input", (e) => {
              questions[e.target.dataset.qIndex].options[
                e.target.dataset.oIndex
              ] = e.target.value;
            })
          );
          document.querySelectorAll('input[type="radio"]').forEach((el) =>
            el.addEventListener("change", (e) => {
              questions[e.target.name.split("-")[2]].correctAnswerIndex =
                parseInt(e.target.value);
            })
          );
        };

        showModal(`
                <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg transform transition-all">
                    <form id="pool-form">
                         <div class="p-6 border-b flex justify-between items-center">
                            <h2 class="text-2xl font-bold">Create New Question Pool</h2>
                            <button type="button" id="ai-generate-btn" class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-4 py-2 rounded-lg font-semibold text-sm">✨ Generate with AI</button>
                        </div>
                        <div class="p-6 max-h-[60vh] overflow-y-auto modal-body">
                            <label class="font-semibold">Pool Name</label>
                            <input type="text" id="pool-name" class="w-full p-2 mt-1 mb-6 bg-stone-100 rounded-lg border" required />
                            <div id="questions-container"></div>
                            <button type="button" id="add-question-btn" class="mt-4 text-sm font-semibold text-blue-500 hover:underline">+ Add Another Question</button>
                        </div>
                        <div class="p-6 bg-stone-50 flex justify-end gap-4 rounded-b-2xl">
                            <button type="button" id="cancel-pool" class="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg font-semibold">Cancel</button>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold">Save Pool</button>
                        </div>
                    </form>
                </div>
            `);

        document
          .getElementById("ai-generate-btn")
          .addEventListener("click", () => {
            renderAIGeneratorModal(questions, renderQuestions);
          });

        const poolNameInput = document.getElementById("pool-name");
        const modalBody = modalContainer.querySelector(".modal-body");

        poolNameInput.addEventListener("input", () => {
          poolName = poolNameInput.value;
        });

        document
          .getElementById("cancel-pool")
          .addEventListener("click", hideModal);
        document.getElementById("pool-form").addEventListener("submit", (e) => {
          e.preventDefault();
          if (
            !poolName ||
            questions.some((q) => !q.questionText || q.options.some((o) => !o))
          ) {
            alert("Please fill out all fields.");
            return;
          }
          database.questionPools.push({
            id: generateId(),
            name: poolName,
            teacherId: currentUser.uid,
            questions,
          });
          saveDatabase();
          hideModal();
          renderTeacherDashboard();
        });
        document
          .getElementById("add-question-btn")
          .addEventListener("click", () => {
            if (
              questions.length === 1 &&
              !questions[0].questionText.trim() &&
              questions[0].options.every((o) => !o.trim())
            ) {
              questions.length = 0;
            }
            questions.push({
              questionText: "",
              options: ["", ""],
              correctAnswerIndex: 0,
            });
            renderQuestions();
            poolNameInput.value = poolName;
            modalBody.scrollTop = modalBody.scrollHeight;
          });

        renderQuestions();
      };

      const renderAIGeneratorModal = (questions, onComplete) => {
        const aiModalContent = `
            <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg transform transition-all">
                <div class="p-6 border-b">
                    <h2 class="text-2xl font-bold">AI Question Generator</h2>
                    <p class="text-sm text-stone-500">Paste your content below and the AI will create questions for you.</p>
                </div>
                <div class="p-6 modal-body">
                    <textarea id="ai-source-text" class="w-full h-64 p-3 bg-stone-50 rounded-lg border" placeholder="Paste your article, chapter, or notes here..."></textarea>
                    <div id="ai-error" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mt-4 text-sm"></div>
                </div>
                <div class="p-6 bg-stone-50 flex justify-end gap-4 rounded-b-2xl">
                    <button type="button" id="cancel-ai" class="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg font-semibold">Cancel</button>
                    <button type="button" id="generate-ai-questions-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 disabled:opacity-50">
                        <span id="ai-btn-text">Generate Questions</span>
                        <span id="ai-spinner" class="spinner hidden"></span>
                    </button>
                </div>
            </div>
        `;

        const aiModalContainer = document.createElement("div");
        aiModalContainer.id = "ai-modal";
        aiModalContainer.className =
          "fixed inset-0 z-[110] flex items-center justify-center p-4 bg-black/30 backdrop-blur-sm";
        aiModalContainer.innerHTML = aiModalContent;
        document.body.appendChild(aiModalContainer);

        const closeAiModal = () =>
          document.getElementById("ai-modal")?.remove();

        document
          .getElementById("cancel-ai")
          .addEventListener("click", closeAiModal);
        document
          .getElementById("generate-ai-questions-btn")
          .addEventListener("click", async () => {
            const sourceText = document.getElementById("ai-source-text").value;
            if (!sourceText.trim()) {
              alert("Please paste some text to generate questions from.");
              return;
            }

            const newQuestions = await handleAIGenerate(sourceText);
            if (newQuestions) {
              if (
                questions.length === 1 &&
                !questions[0].questionText.trim() &&
                questions[0].options.every((o) => !o.trim())
              ) {
                questions.length = 0;
              }
              questions.push(...newQuestions);
              onComplete();
              closeAiModal();
            }
          });
      };

      const handleAIGenerate = async (sourceText) => {
        const generateBtn = document.getElementById(
          "generate-ai-questions-btn"
        );
        const btnText = document.getElementById("ai-btn-text");
        const spinner = document.getElementById("ai-spinner");
        const errorEl = document.getElementById("ai-error");

        errorEl.classList.add("hidden");
        generateBtn.disabled = true;
        btnText.textContent = "Generating...";
        spinner.classList.remove("hidden");

        if (
          OPENROUTER_API_KEY === "YOUR_OPENROUTER_KEY" ||
          !OPENROUTER_API_KEY
        ) {
          errorEl.textContent =
            "API Key not found. Please add your OpenRouter API key to the script file.";
          errorEl.classList.remove("hidden");
          generateBtn.disabled = false;
          btnText.textContent = "Generate Questions";
          spinner.classList.add("hidden");
          return null;
        }

        const prompt = `You are an expert quiz designer. Based on the following text, generate 5 multiple-choice questions. For each question, provide 4 options and indicate the correct answer. Format your entire response as a single JSON object. The JSON object must contain a single key named "questions" which is an array of question objects. Each question object must have these exact keys: "questionText" (string), "options" (an array of 4 strings), and "correctAnswerIndex" (an integer from 0 to 3 indicating the index of the correct option). Do not include any other text, explanations, or markdown formatting outside of the JSON object. Here is the text: \n\n${sourceText}`;

        try {
          const response = await fetch(
            "https://openrouter.ai/api/v1/chat/completions",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${OPENROUTER_API_KEY}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: "google/gemini-flash-1.5",
                messages: [{ role: "user", content: prompt }],
                response_format: { type: "json_object" },
              }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message ||
                `HTTP error! status: ${response.status}`
            );
          }

          const data = await response.json();
          const content = data.choices[0].message.content;
          const parsedContent = JSON.parse(content);

          if (
            !parsedContent.questions ||
            !Array.isArray(parsedContent.questions)
          ) {
            throw new Error(
              "AI response did not contain a valid 'questions' array."
            );
          }

          return parsedContent.questions;
        } catch (error) {
          console.error("AI Generation Error:", error);
          errorEl.textContent = `An error occurred: ${error.message}. Please check the console for details.`;
          errorEl.classList.remove("hidden");
          return null;
        } finally {
          generateBtn.disabled = false;
          btnText.textContent = "Generate Questions";
          spinner.classList.add("hidden");
        }
      };

      const renderCreateQuizModal = () => {
        const pools = database.questionPools.filter(
          (p) => p.teacherId === currentUser.uid
        );
        if (pools.length === 0) {
          alert("You must create a question pool before creating a quiz.");
          return;
        }

        showModal(`
                <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg transform transition-all">
                    <form id="quiz-form">
                        <div class="p-6 border-b"><h2 class="text-2xl font-bold">Create New Quiz</h2></div>
                        <div class="p-6 space-y-4 modal-body">
                            <div><label class="font-semibold">Quiz Title</label><input type="text" id="quiz-title" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border" required /></div>
                            <div><label class="font-semibold">Select Question Pool</label><select id="quiz-pool" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border">${pools
                              .map(
                                (p) =>
                                  `<option value="${p.id}">${p.name} (${p.questions.length} questions)</option>`
                              )
                              .join("")}</select></div>
                            <div><label class="font-semibold">Number of Questions to Ask</label><input type="number" id="quiz-questions-num" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border" min="1" required /></div>
                            <div><label class="font-semibold">Overall Time Limit (minutes)</label><input type="number" id="quiz-time" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border" min="1" required /></div>
                            <div><label class="font-semibold">Time Per Question (seconds, optional)</label><input type="number" id="quiz-question-time" class="w-full p-2 mt-1 bg-stone-100 rounded-lg border" min="60" placeholder="Min 60 seconds (1 minute)" /></div>
                        </div>
                        <div class="p-6 bg-stone-50 flex justify-end gap-4 rounded-b-2xl">
                            <button type="button" id="cancel-quiz" class="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg font-semibold">Cancel</button>
                            <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold">Create Quiz</button>
                        </div>
                    </form>
                </div>
            `);

        document
          .getElementById("cancel-quiz")
          .addEventListener("click", hideModal);
        document.getElementById("quiz-form").addEventListener("submit", (e) => {
          e.preventDefault();
          const quizTitle = document.getElementById("quiz-title").value;
          const poolId = document.getElementById("quiz-pool").value;
          const numberOfQuestions = parseInt(
            document.getElementById("quiz-questions-num").value
          );
          const totalTime = parseInt(
            document.getElementById("quiz-time").value
          );
          const timePerQuestion = document.getElementById("quiz-question-time")
            .value
            ? parseInt(document.getElementById("quiz-question-time").value)
            : null;

          const selectedPool = pools.find((p) => p.id === poolId);
          if (numberOfQuestions > selectedPool.questions.length) {
            alert(
              `You can only ask for a maximum of ${selectedPool.questions.length} questions from this pool.`
            );
            return;
          }

          database.quizzes.push({
            id: generateId(),
            quizTitle,
            poolId,
            numberOfQuestions,
            totalTime,
            timePerQuestion,
            teacherId: currentUser.uid,
            published: false,
            createdAt: new Date(),
          });
          saveDatabase();
          hideModal();
          renderTeacherDashboard();
        });
      };

      const renderQuizResultsModal = (quizId) => {
        loadDatabase();
        const quiz = database.quizzes.find((q) => q.id === quizId);
        showModal(`
                <div class="w-full max-w-5xl bg-white rounded-2xl shadow-lg transform transition-all">
                    <div class="p-6 border-b flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold">Quiz Analytics</h2>
                            <p class="text-stone-500">${quiz.quizTitle}</p>
                        </div>
                        <button id="close-results" class="text-2xl">&times;</button>
                    </div>
                    <div id="results-body" class="p-6 max-h-[80vh] overflow-y-auto modal-body"></div>
                </div>
            `);
        document
          .getElementById("close-results")
          .addEventListener("click", hideModal);

        const resultsBody = document.getElementById("results-body");
        const attempts = database.quizAttempts.filter(
          (a) => a.quizId === quizId
        );

        if (attempts.length === 0) {
          resultsBody.innerHTML = `<p class="text-stone-500 text-center py-4">No students have completed this quiz yet.</p>`;
          return;
        }

        const scores = attempts.map((a) => (a.score / a.totalQuestions) * 100);
        const averageScore =
          scores.reduce((sum, score) => sum + score, 0) / scores.length;
        const highestScore = Math.max(...scores);
        const lowestScore = Math.min(...scores);

        const questionStats = {};
        attempts.forEach((attempt) => {
          if (!attempt.questions) return;
          attempt.questions.forEach((q, index) => {
            const questionText = q.questionText;
            if (!questionStats[questionText]) {
              questionStats[questionText] = {
                correct: 0,
                total: 0,
                answers: {},
              };
            }
            questionStats[questionText].total++;
            const studentAnswerIndex = attempt.answers[index];
            if (studentAnswerIndex === q.correctAnswerIndex) {
              questionStats[questionText].correct++;
            }
            questionStats[questionText].answers[studentAnswerIndex] =
              (questionStats[questionText].answers[studentAnswerIndex] || 0) +
              1;
          });
        });

        const questionBreakdown = Object.entries(questionStats)
          .map(([text, stats]) => ({
            text,
            percent: (stats.correct / stats.total) * 100,
            answers: stats.answers,
            options:
              database.questionPools
                .find((p) => p.id === quiz.poolId)
                ?.questions.find((q) => q.questionText === text)?.options || [],
          }))
          .sort((a, b) => a.percent - b.percent);

        const scoreBrackets = {
          "0-19%": 0,
          "20-39%": 0,
          "40-59%": 0,
          "60-79%": 0,
          "80-100%": 0,
        };
        scores.forEach((score) => {
          if (score < 20) scoreBrackets["0-19%"]++;
          else if (score < 40) scoreBrackets["20-39%"]++;
          else if (score < 60) scoreBrackets["40-59%"]++;
          else if (score < 80) scoreBrackets["60-79%"]++;
          else scoreBrackets["80-100%"]++;
        });

        const scatterData = attempts
          .filter((a) => a.completionTimeInSeconds !== undefined)
          .map((a) => ({
            x: a.completionTimeInSeconds / 60, // in minutes
            y: (a.score / a.totalQuestions) * 100,
          }));

        resultsBody.innerHTML = `
                <div class="border-b border-gray-200 mb-4">
                    <nav class="-mb-px flex gap-6" id="analytics-tabs">
                        <button data-tab="summary" class="analytics-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-orange-500 text-orange-600">Summary & Results</button>
                        <button data-tab="questions" class="analytics-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Question Details</button>
                        <button data-tab="performance" class="analytics-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Performance</button>
                    </nav>
                </div>

                <div id="tab-summary" class="analytics-tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center">
                        <div class="bg-blue-50 p-4 rounded-lg"><div class="text-sm text-blue-600 font-semibold">Class Average</div><div class="text-3xl font-bold text-blue-800">${averageScore.toFixed(
                          1
                        )}%</div></div>
                        <div class="bg-green-50 p-4 rounded-lg"><div class="text-sm text-green-600 font-semibold">Highest Score</div><div class="text-3xl font-bold text-green-800">${highestScore.toFixed(
                          1
                        )}%</div></div>
                        <div class="bg-red-50 p-4 rounded-lg"><div class="text-sm text-red-600 font-semibold">Lowest Score</div><div class="text-3xl font-bold text-red-800">${lowestScore.toFixed(
                          1
                        )}%</div></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2 text-center">Score Distribution</h3>
                        <div class="max-w-xl mx-auto"><canvas id="class-performance-chart"></canvas></div>
                    </div>
                    <hr class="my-8"/>
                    <h3 class="text-lg font-semibold mb-4 text-center">Individual Results</h3>
                    <table class="w-full text-left">
                        <thead><tr class="border-b"><th class="p-2">Student</th><th class="p-2">Score</th><th class="p-2">Time</th><th class="p-2">Date</th></tr></thead>
                        <tbody>
                            ${attempts
                              .sort((a, b) => b.score - a.score)
                              .map(
                                (attempt) => `
                            <tr class="border-b hover:bg-stone-50">
                                <td class="p-2">${attempt.studentName}</td>
                                <td class="p-2">${attempt.score} / ${
                                  attempt.totalQuestions
                                } (${(
                                  (attempt.score / attempt.totalQuestions) *
                                  100
                                ).toFixed(0)}%)</td>
                                <td class="p-2 text-sm">${
                                  attempt.completionTimeInSeconds
                                    ? `${Math.floor(
                                        attempt.completionTimeInSeconds / 60
                                      )}m ${
                                        attempt.completionTimeInSeconds % 60
                                      }s`
                                    : "N/A"
                                }</td>
                                <td class="p-2 text-sm text-stone-500">${new Date(
                                  attempt.timestamp
                                ).toLocaleString()}</td>
                            </tr>`
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>

                <div id="tab-questions" class="analytics-tab-content hidden">
                    <div class="space-y-3">
                        ${
                          questionBreakdown.length > 0
                            ? questionBreakdown
                                .map(
                                  (q, index) => `
                            <div class="p-3 bg-stone-50 rounded-md">
                                <details>
                                    <summary class="flex justify-between items-center text-sm cursor-pointer">
                                        <p class="font-semibold text-stone-700 truncate pr-4">${
                                          q.text
                                        }</p>
                                        <p class="font-bold flex-shrink-0 ${
                                          q.percent < 50
                                            ? "text-red-500"
                                            : "text-green-500"
                                        }">${q.percent.toFixed(0)}% Correct</p>
                                    </summary>
                                    <div class="mt-4 pt-4 border-t">
                                        <canvas id="distractor-chart-${index}" height="100"></canvas>
                                    </div>
                                </details>
                            </div>`
                                )
                                .join("")
                            : `<div class="p-4 text-center text-stone-500 bg-stone-50 rounded-lg">No detailed question data available. New quiz attempts are required to populate this section.</div>`
                        }
                    </div>
                </div>

                <div id="tab-performance" class="analytics-tab-content hidden">
                     <h3 class="text-lg font-semibold mb-2 text-center">Score vs. Completion Time</h3>
                     <p class="text-center text-sm text-stone-500 mb-4">Each dot represents a student's attempt.</p>
                     ${
                       scatterData.length > 0
                         ? '<div class="max-w-2xl mx-auto"><canvas id="score-time-chart"></canvas></div>'
                         : '<p class="text-center text-stone-500 py-8">No completion time data available.</p>'
                     }
                </div>
            `;

        // --- Render All Charts ---
        const tabs = document.querySelectorAll(".analytics-tab");
        const tabContents = document.querySelectorAll(".analytics-tab-content");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            tabs.forEach((t) =>
              t.classList.remove("border-orange-500", "text-orange-600")
            );
            tab.classList.add("border-orange-500", "text-orange-600");
            tabContents.forEach((c) => c.classList.add("hidden"));
            document
              .getElementById(`tab-${tab.dataset.tab}`)
              .classList.remove("hidden");
          });
        });

        // Chart 1: Score Distribution
        const scoreCtx = document
          .getElementById("class-performance-chart")
          .getContext("2d");
        analyticsCharts.push(
          new Chart(scoreCtx, {
            type: "bar",
            data: {
              labels: Object.keys(scoreBrackets),
              datasets: [
                {
                  label: "Number of Students",
                  data: Object.values(scoreBrackets),
                  backgroundColor: "rgba(249, 115, 22, 0.6)",
                  borderColor: "rgba(249, 115, 22, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
              plugins: { legend: { display: false } },
            },
          })
        );

        // Chart 2: Distractor analysis charts
        questionBreakdown.forEach((q, index) => {
          const distractorCtx = document
            .getElementById(`distractor-chart-${index}`)
            .getContext("2d");
          const correctOptionIndex = database.questionPools
            .find((p) => p.id === quiz.poolId)
            ?.questions.find(
              (item) => item.questionText === q.text
            )?.correctAnswerIndex;
          analyticsCharts.push(
            new Chart(distractorCtx, {
              type: "bar",
              data: {
                labels: q.options,
                datasets: [
                  {
                    label: "# of Students",
                    data: q.options.map((opt, i) => q.answers[i] || 0),
                    backgroundColor: q.options.map((opt, i) =>
                      i === correctOptionIndex
                        ? "rgba(34, 197, 94, 0.6)"
                        : "rgba(239, 68, 68, 0.6)"
                    ),
                    borderColor: q.options.map((opt, i) =>
                      i === correctOptionIndex
                        ? "rgba(34, 197, 94, 1)"
                        : "rgba(239, 68, 68, 1)"
                    ),
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                indexAxis: "y",
                scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
                plugins: { legend: { display: false } },
              },
            })
          );
        });

        // Chart 3: Scatter Plot
        if (scatterData.length > 0) {
          const scatterCtx = document
            .getElementById("score-time-chart")
            .getContext("2d");
          analyticsCharts.push(
            new Chart(scatterCtx, {
              type: "scatter",
              data: {
                datasets: [
                  {
                    label: "Student Attempt",
                    data: scatterData,
                    backgroundColor: "rgba(59, 130, 246, 0.7)",
                  },
                ],
              },
              options: {
                scales: {
                  x: {
                    title: {
                      display: true,
                      text: "Time to Complete (Minutes)",
                    },
                    beginAtZero: true,
                  },
                  y: {
                    title: { display: true, text: "Score (%)" },
                    min: 0,
                    max: 100,
                  },
                },
                plugins: { legend: { display: false } },
              },
            })
          );
        }
      };

      const renderStudentDashboard = () => {
        const studentAttempts = database.quizAttempts
          .filter((a) => a.studentId === currentUser.uid)
          .sort((a, b) => a.timestamp - b.timestamp);

        let totalScore = 0;
        let totalQuestions = 0;
        studentAttempts.forEach((a) => {
          totalScore += a.score;
          totalQuestions += a.totalQuestions;
        });
        const averageScore =
          totalQuestions > 0 ? (totalScore / totalQuestions) * 100 : 0;

        mainContent.innerHTML = `
            <div class="p-4 md:p-8 max-w-7xl mx-auto view-content">
                <h1 class="text-3xl md:text-4xl font-bold mb-8">Welcome back, <span class="text-orange-500">${
                  currentUser.name
                }</span>!</h1>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="lg:col-span-2">
                        <h2 class="text-2xl font-semibold mb-4">Take a New Quiz</h2>
                        <div class="bg-white rounded-2xl shadow-lg p-8">
                             <div id="student-error" class="hidden bg-red-100 text-red-700 p-3 rounded-lg mb-4 text-sm"></div>
                             <input type="text" id="quiz-code-input" placeholder="Enter Quiz Code" class="w-full p-4 text-center text-lg bg-stone-50 rounded-lg border border-stone-200 focus:outline-none focus:ring-2 focus:ring-orange-400 uppercase" />
                             <button id="start-quiz-btn" class="w-full mt-4 bg-orange-500 text-white p-4 rounded-lg font-semibold text-lg hover:bg-orange-600 transition-colors">
                                 Start Quiz
                             </button>
                        </div>
                    </div>

                    <div class="lg:col-span-3">
                        <h2 class="text-2xl font-semibold mb-4">My Progress</h2>
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <p class="text-sm font-medium text-stone-500">Overall Average</p>
                                    <p class="text-4xl font-bold text-blue-500 mt-2">${averageScore.toFixed(
                                      1
                                    )}%</p>
                                </div>
                                <div class="bg-white p-6 rounded-2xl shadow-lg">
                                    <p class="text-sm font-medium text-stone-500">Quizzes Taken</p>
                                    <p class="text-4xl font-bold text-green-500 mt-2">${
                                      studentAttempts.length
                                    }</p>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="font-semibold mb-4">Performance Over Time</h3>
                                <canvas id="student-progress-chart" height="120"></canvas>
                                <p id="student-chart-placeholder" class="text-stone-500 text-center py-8 hidden">Take at least two quizzes to see your progress graph.</p>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="font-semibold mb-4">Quiz History</h3>
                                <div class="max-h-64 overflow-y-auto space-y-3 history-list pr-2">
                                    ${
                                      studentAttempts.length > 0
                                        ? [...studentAttempts]
                                            .reverse()
                                            .map((attempt) => {
                                              const quiz =
                                                database.quizzes.find(
                                                  (q) => q.id === attempt.quizId
                                                );
                                              return `
                                                <div class="flex justify-between items-center p-3 bg-stone-50 rounded-lg">
                                                    <div>
                                                        <p class="font-semibold">${
                                                          quiz
                                                            ? quiz.quizTitle
                                                            : "Unknown Quiz"
                                                        }</p>
                                                        <p class="text-xs text-stone-500">${new Date(
                                                          attempt.timestamp
                                                        ).toLocaleDateString()}</p>
                                                    </div>
                                                    <p class="font-bold text-lg">${
                                                      attempt.score
                                                    } / ${
                                                attempt.totalQuestions
                                              }</p>
                                                </div>
                                            `;
                                            })
                                            .join("")
                                        : `<p class="text-stone-500 text-center py-8">You haven't taken any quizzes yet!</p>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        document
          .getElementById("start-quiz-btn")
          .addEventListener("click", handleStartQuiz);

        const chartCanvas = document.getElementById("student-progress-chart");
        const chartPlaceholder = document.getElementById(
          "student-chart-placeholder"
        );
        if (studentAttempts.length < 2) {
          chartCanvas.classList.add("hidden");
          chartPlaceholder.classList.remove("hidden");
        } else {
          const chartLabels = studentAttempts.map((a) =>
            new Date(a.timestamp).toLocaleDateString()
          );
          const chartData = studentAttempts.map(
            (a) => (a.score / a.totalQuestions) * 100
          );
          const ctx = chartCanvas.getContext("2d");
          if (activeChart) activeChart.destroy();
          activeChart = new Chart(ctx, {
            type: "line",
            data: {
              labels: chartLabels,
              datasets: [
                {
                  label: "Score (%)",
                  data: chartData,
                  fill: false,
                  borderColor: "#f97316",
                  tension: 0.1,
                },
              ],
            },
            options: {
              scales: { y: { beginAtZero: true, max: 100 } },
              plugins: { legend: { display: false } },
            },
          });
        }
      };

      const handleStartQuiz = () => {
        loadDatabase();
        if (activeChart) {
          activeChart.destroy();
          activeChart = null;
        }
        const errorEl = document.getElementById("student-error");
        errorEl.classList.add("hidden");
        const quizCode = document
          .getElementById("quiz-code-input")
          .value.trim()
          .toUpperCase();
        if (!quizCode) {
          errorEl.textContent = "Please enter a quiz code.";
          errorEl.classList.remove("hidden");
          return;
        }
        const quiz = database.quizzes.find((q) => q.id === quizCode);

        if (quiz && quiz.published) {
          renderQuizTaker(quiz);
        } else if (quiz && !quiz.published) {
          errorEl.textContent =
            "This quiz has not been published by your teacher yet.";
          errorEl.classList.remove("hidden");
        } else {
          errorEl.textContent =
            "Quiz not found. Please check the code and try again.";
          errorEl.classList.remove("hidden");
        }
      };

      const renderQuizTaker = (quiz) => {
        const startTime = Date.now();
        const questions = quiz.isPractice
          ? quiz.questions
          : shuffleArray(
              database.questionPools.find((p) => p.id === quiz.poolId)
                ?.questions || []
            ).slice(0, quiz.numberOfQuestions);

        if (!questions || questions.length === 0) {
          mainContent.innerHTML = `<div class="p-8 text-center"><p class="text-red-500">Error: Could not load questions for this quiz.</p></div>`;
          return;
        }

        let currentQuestionIndex = 0;
        let answers = {};
        let score = null;
        let totalTimeLeft = quiz.totalTime * 60;
        let questionTimeLeft = quiz.timePerQuestion;

        const handleSubmit = () => {
          const endTime = Date.now();
          const completionTimeInSeconds = Math.round(
            (endTime - startTime) / 1000
          );

          if (quiz.isPractice) {
            let practiceScore = 0;
            questions.forEach((q, index) => {
              if (answers[index] === q.correctAnswerIndex) practiceScore++;
            });
            alert(
              `Practice Complete!\n\nYou scored: ${practiceScore} / ${questions.length}\n\nThis result will not be saved.`
            );
            renderStudentDashboard();
            return;
          }

          if (score !== null) return;
          clearInterval(quizTimerInterval);
          clearInterval(questionTimerInterval);

          let calculatedScore = 0;
          questions.forEach((q, index) => {
            if (answers[index] === q.correctAnswerIndex) {
              calculatedScore++;
            }
          });
          score = calculatedScore;

          database.quizAttempts.push({
            quizId: quiz.id,
            studentId: currentUser.uid,
            studentName: currentUser.name,
            score: calculatedScore,
            totalQuestions: questions.length,
            answers,
            questions: questions,
            completionTimeInSeconds,
            timestamp: new Date(),
          });
          saveDatabase();

          const newAttempt =
            database.quizAttempts[database.quizAttempts.length - 1];
          renderQuizResults(newAttempt);
        };

        const renderQuizResults = (attempt) => {
          const quote = getMotivationalQuote(
            currentUser.uid,
            attempt.score,
            attempt.totalQuestions
          );
          const quizInfo = database.quizzes.find(
            (q) => q.id === attempt.quizId
          );
          const isPerfectScore = attempt.score === attempt.totalQuestions;

          mainContent.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center p-4 view-content">
                            <div class="w-full max-w-lg text-center bg-white rounded-2xl shadow-lg p-8">
                                <h2 class="text-3xl font-bold text-stone-800 mb-2">Quiz Complete!</h2>
                                <p class="text-lg text-stone-500 mb-6">${
                                  quizInfo.quizTitle
                                }</p>
                                <p class="text-6xl font-bold text-orange-500 my-4">${
                                  attempt.score
                                } / ${attempt.totalQuestions}</p>
                                <p class="text-lg italic text-stone-600 mt-6 mb-8">"${quote}"</p>
                                <div id="results-actions" class="flex flex-wrap justify-center gap-4">
                                    <button id="back-to-dash-btn" class="bg-stone-200 text-stone-700 px-6 py-3 rounded-lg font-semibold hover:bg-stone-300">Back to Dashboard</button>
                                    <button id="review-answers-btn" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600">Review Your Answers</button>
                                    ${
                                      !isPerfectScore
                                        ? `
                                    <button id="adaptive-quiz-btn" class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 flex items-center gap-2">
                                        <span id="adaptive-btn-text">✨ Generate Practice Quiz</span>
                                        <span id="adaptive-spinner" class="spinner hidden"></span>
                                    </button>
                                    `
                                        : ""
                                    }
                                </div>
                            </div>
                        </div>
                    `;
          document
            .getElementById("back-to-dash-btn")
            .addEventListener("click", renderStudentDashboard);
          document
            .getElementById("review-answers-btn")
            .addEventListener("click", () => renderQuizReview(attempt));

          if (!isPerfectScore) {
            document
              .getElementById("adaptive-quiz-btn")
              .addEventListener("click", () =>
                handleAdaptiveQuizGeneration(attempt)
              );
          }
        };

        const nextQuestion = () => {
          if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            renderQuestion();
          } else {
            handleSubmit();
          }
        };

        const prevQuestion = () => {
          if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuestion();
          }
        };

        const renderQuestion = () => {
          if (score !== null) return;
          const q = questions[currentQuestionIndex];
          const totalMinutes = Math.floor(totalTimeLeft / 60);
          const totalSeconds = totalTimeLeft % 60;

          mainContent.innerHTML = `
                        <div class="min-h-screen p-4 md:p-8 view-content">
                            <div class="max-w-3xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
                                <div class="p-6 border-b flex justify-between items-center">
                                    <div>
                                        <h2 class="text-2xl font-bold text-stone-800">${
                                          quiz.quizTitle
                                        }</h2>
                                        <p class="text-stone-500">Question ${
                                          currentQuestionIndex + 1
                                        } of ${questions.length}</p>
                                    </div>
                                    <div id="total-timer" class="bg-orange-100 text-orange-600 font-bold text-lg px-4 py-2 rounded-full">
                                        ${totalMinutes}:${
            totalSeconds < 10 ? `0${totalSeconds}` : totalSeconds
          }
                                    </div>
                                </div>
                                <div class="p-6">
                                    ${
                                      quiz.timePerQuestion
                                        ? `<div class="text-center mb-4"><p class="text-sm text-stone-500">Time for this question: <span id="question-timer" class="font-bold">${questionTimeLeft}s</span></p></div>`
                                        : ""
                                    }
                                    <p class="text-xl text-stone-700 mb-6">${
                                      q.questionText
                                    }</p>
                                    <div id="options-container" class="space-y-3">
                                        ${q.options
                                          .map((option, index) => {
                                            const isSelected =
                                              answers[currentQuestionIndex] ===
                                              index;
                                            return `
                                                <button data-option-index="${index}" class="option-btn w-full text-left p-4 rounded-lg border-2 transition-all ${
                                              isSelected
                                                ? "bg-orange-500 border-orange-500 text-white"
                                                : "bg-white border-stone-200 text-stone-800 hover:border-orange-400 hover:bg-orange-50"
                                            }">
                                                    ${option}
                                                </button>
                                                `;
                                          })
                                          .join("")}
                                    </div>
                                </div>
                                <div class="p-6 bg-stone-50 flex justify-between items-center">
                                    <button id="prev-btn" class="bg-stone-200 text-stone-700 px-4 py-2 rounded-lg font-semibold hover:bg-stone-300 disabled:opacity-50 disabled:cursor-not-allowed" ${
                                      currentQuestionIndex === 0
                                        ? "disabled"
                                        : ""
                                    }>Previous</button>
                                    <div class="flex gap-4">
                                      <button id="clear-btn" class="bg-gray-400 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed" ${
                                        answers[currentQuestionIndex] ===
                                        undefined
                                          ? "disabled"
                                          : ""
                                      }>Clear Selection</button>
                                      <button id="next-btn" class="bg-orange-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-600">${
                                        currentQuestionIndex <
                                        questions.length - 1
                                          ? "Next"
                                          : "Submit Quiz"
                                      }</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

          const optionsContainer = document.getElementById("options-container");
          optionsContainer.addEventListener("click", (e) => {
            if (e.target.classList.contains("option-btn")) {
              answers[currentQuestionIndex] = parseInt(
                e.target.dataset.optionIndex
              );
              renderQuestion();
            }
          });

          document.getElementById("clear-btn").addEventListener("click", () => {
            delete answers[currentQuestionIndex];
            renderQuestion();
          });

          document
            .getElementById("prev-btn")
            .addEventListener("click", prevQuestion);
          document
            .getElementById("next-btn")
            .addEventListener("click", nextQuestion);
        };

        quizTimerInterval = setInterval(() => {
          totalTimeLeft--;
          if (totalTimeLeft <= 0) handleSubmit();
          const timerEl = document.getElementById("total-timer");
          if (timerEl) {
            const minutes = Math.floor(totalTimeLeft / 60);
            const seconds = totalTimeLeft % 60;
            timerEl.textContent = `${minutes}:${
              seconds < 10 ? `0${seconds}` : seconds
            }`;
          }
        }, 1000);

        if (quiz.timePerQuestion) {
          questionTimerInterval = setInterval(() => {
            questionTimeLeft--;
            if (questionTimeLeft <= 0) nextQuestion();
            const qTimerEl = document.getElementById("question-timer");
            if (qTimerEl) qTimerEl.textContent = `${questionTimeLeft}s`;
          }, 1000);
        }

        renderQuestion();
      };

      const renderQuizReview = (attempt) => {
        const quiz = database.quizzes.find((q) => q.id === attempt.quizId);
        mainContent.innerHTML = `
            <div class="p-4 md:p-8 max-w-3xl mx-auto view-content">
                <h1 class="text-3xl font-bold">Reviewing: <span class="text-orange-500">${
                  quiz.quizTitle
                }</span></h1>
                <p class="text-stone-600 mt-1 mb-8">Your score: ${
                  attempt.score
                } / ${attempt.totalQuestions}</p>
                
                <div class="space-y-6">
                    ${attempt.questions
                      .map((q, index) => {
                        const studentAnswerIndex = attempt.answers[index];
                        const correctAnswerIndex = q.correctAnswerIndex;
                        return `
                        <div class="bg-white p-6 rounded-xl shadow-sm">
                            <p class="text-lg font-semibold text-stone-800 mb-4">Question ${
                              index + 1
                            }: ${q.questionText}</p>
                            <div class="space-y-3">
                                ${q.options
                                  .map((option, oIndex) => {
                                    let optionClasses = "border-stone-300";
                                    let indicator = "";

                                    if (oIndex === correctAnswerIndex) {
                                      optionClasses =
                                        "border-green-500 bg-green-50";
                                      indicator =
                                        '<span class="text-green-600 font-bold ml-2">✓ Correct</span>';
                                    }
                                    if (
                                      oIndex === studentAnswerIndex &&
                                      studentAnswerIndex !== correctAnswerIndex
                                    ) {
                                      optionClasses =
                                        "border-red-500 bg-red-50";
                                      indicator =
                                        '<span class="text-red-600 font-bold ml-2">✗ Your Answer</span>';
                                    }

                                    return `<div class="p-3 rounded-lg border-2 ${optionClasses}">${option} ${indicator}</div>`;
                                  })
                                  .join("")}
                            </div>
                        </div>
                        `;
                      })
                      .join("")}
                </div>
                <div class="text-center mt-8">
                     <button id="review-done-btn" class="bg-orange-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-orange-600">Back to Dashboard</button>
                </div>
            </div>
        `;
        document
          .getElementById("review-done-btn")
          .addEventListener("click", renderStudentDashboard);
      };

      const handleAdaptiveQuizGeneration = async (attempt) => {
        const actionsContainer = document.getElementById("results-actions");
        const generateBtn = document.getElementById("adaptive-quiz-btn");
        const btnText = document.getElementById("adaptive-btn-text");
        const spinner = document.getElementById("adaptive-spinner");

        actionsContainer
          .querySelectorAll("button")
          .forEach((btn) => (btn.disabled = true));
        btnText.textContent = "Generating...";
        spinner.classList.remove("hidden");

        const incorrectQuestions = attempt.questions.filter(
          (q, index) => attempt.answers[index] !== q.correctAnswerIndex
        );
        const incorrectQuestionTexts = incorrectQuestions
          .map((q, i) => `Question ${i + 1}: ${q.questionText}`)
          .join("\n");

        const prompt = `You are an expert tutor. A student answered the following quiz questions incorrectly. Based on these questions, identify the core concepts the student is struggling with. Then, generate ${Math.min(
          3,
          incorrectQuestions.length
        )} new multiple-choice questions that test these same concepts but are worded differently. Format your entire response as a single JSON object with a single key "questions", which is an array of question objects. Each object must have keys: "questionText" (string), "options" (array of 4 strings), and "correctAnswerIndex" (integer 0-3). Do not include any other text outside the JSON object. Here are the questions the student got wrong:\n\n${incorrectQuestionTexts}`;

        try {
          const response = await fetch(
            "https://openrouter.ai/api/v1/chat/completions",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${OPENROUTER_API_KEY}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model: "google/gemini-flash-1.5",
                messages: [{ role: "user", content: prompt }],
                response_format: { type: "json_object" },
              }),
            }
          );

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error?.message ||
                `HTTP error! status: ${response.status}`
            );
          }

          const data = await response.json();
          const content = data.choices[0].message.content;
          const parsedContent = JSON.parse(content);

          if (
            !parsedContent.questions ||
            !Array.isArray(parsedContent.questions)
          ) {
            throw new Error(
              "AI response did not contain a valid 'questions' array."
            );
          }

          const practiceQuiz = {
            quizTitle: "Personalized Practice Session",
            numberOfQuestions: parsedContent.questions.length,
            totalTime: 5 * parsedContent.questions.length,
            timePerQuestion: null,
            isPractice: true,
            questions: parsedContent.questions,
          };

          renderQuizTaker(practiceQuiz);
        } catch (error) {
          console.error("Adaptive Quiz Generation Error:", error);
          alert(
            `An error occurred while generating the practice quiz: ${error.message}`
          );
          actionsContainer
            .querySelectorAll("button")
            .forEach((btn) => (btn.disabled = false));
          btnText.textContent = "✨ Generate Practice Quiz";
          spinner.classList.add("hidden");
        }
      };

      const renderManageStudentsModal = () => {
        loadDatabase();
        const teacherQuizIds = database.quizzes
          .filter((q) => q.teacherId === currentUser.uid)
          .map((q) => q.id);
        const relevantAttempts = database.quizAttempts.filter((a) =>
          teacherQuizIds.includes(a.quizId)
        );
        const students = [
          ...new Map(
            relevantAttempts.map((a) => [
              a.studentId,
              { studentId: a.studentId, studentName: a.studentName },
            ])
          ).values(),
        ];

        showModal(`
            <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg transform transition-all">
                <div class="p-6 border-b flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Manage Students</h2>
                    <button id="close-manage-students" class="text-2xl">&times;</button>
                </div>
                <div class="p-6 max-h-[60vh] overflow-y-auto modal-body space-y-3">
                    ${
                      students.length > 0
                        ? students
                            .map(
                              (student) => `
                        <div class="flex justify-between items-center p-3 bg-stone-50 rounded-lg">
                            <p class="font-semibold">${student.studentName}</p>
                            <button data-student-id="${student.studentId}" data-student-name="${student.studentName}" class="reset-student-btn text-xs font-semibold px-3 py-1 rounded-full bg-red-100 text-red-700 hover:bg-red-200">Reset History</button>
                        </div>
                    `
                            )
                            .join("")
                        : '<p class="text-stone-500 text-center py-4">No students have taken any of your quizzes yet.</p>'
                    }
                </div>
            </div>
        `);

        document
          .getElementById("close-manage-students")
          .addEventListener("click", hideModal);

        document.querySelectorAll(".reset-student-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const studentId = e.target.dataset.studentId;
            const studentName = e.target.dataset.studentName;
            renderConfirmationModal(
              `Are you sure you want to reset all quiz history for ${studentName}? This will delete all of their past scores and cannot be undone.`,
              () => {
                database.quizAttempts = database.quizAttempts.filter(
                  (attempt) => attempt.studentId !== studentId
                );
                saveDatabase();
                hideModal(); // Close confirmation modal
                renderManageStudentsModal(); // Re-render the manage students modal
              }
            );
          });
        });
      };

      // --- Start the App ---
      init();
    </script>
  </body>
</html>
